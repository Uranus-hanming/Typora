##  æ”¶è´§åœ°å€



1. æ”¶è´§åœ°å€åˆ—è¡¨
2. æ–°å¢æ”¶è´§åœ°å€
3. ç¼–è¾‘æ”¶è´§åœ°å€
4. åˆ é™¤æ”¶è´§åœ°å€





### 01. å®šä¹‰æ–°å¢å‚æ•°ä»¥åŠå°è£…æ¥å£ API



**æ€è·¯åˆ†æï¼š**



ç‚¹å‡»æ–°å»ºåœ°å€æŒ‰é’®ï¼Œéœ€è¦è·³è½¬åˆ°æ–°å¢åœ°å€é¡µé¢



å› ä¸ºæ–°å¢å’Œç¼–è¾‘æ”¶è´§åœ°å€é¡µé¢æ˜¯åŒä¸€ä¸ªé¡µé¢ï¼Œæˆ‘ä»¬éœ€è¦åœ¨è¿™ä¸ªé¡µé¢å¤„ç†æ–°å¢å’Œç¼–è¾‘åŠŸèƒ½ï¼Œä¸ºäº†åšåŒºåˆ†å¤„ç†ã€‚

æˆ‘ä»¬åœ¨åç»­åšè¿›è¡Œç¼–è¾‘çš„æ—¶å€™ä¼ é€’ `id` å±æ€§ï¼Œå€¼ä¸º æ”¶è´§åœ°å€çš„ `id` å€¼ã€‚



é¦–å…ˆç†Ÿæ‚‰æ¥å£æ–‡æ¡£ï¼š[è·å–ç”¨æˆ·ä¿¡æ¯](https://apifox.com/apidoc/shared-6ed6c5c4-56c4-4619-8e2a-4817aa140e30/api-134640244) 



æ¥æ”¶æ–‡æ¡£åœ¨è¿™ä¸€èŠ‚ï¼Œæˆ‘ä»¬å…ˆæ¥æ”¶é›†æ·»åŠ æ”¶è´§åœ°å€çš„è¯·æ±‚å‚æ•°

| å‚æ•°åç§°     | å‚æ•°è¯´æ˜                                | æ˜¯å¦å¿…é¡» |
| ------------ | :-------------------------------------- | :------- |
| æ”¶è´§äºº       | name                                    | true     |
| æ‰‹æœºå·       | phone                                   | true     |
| çœ           | provinceName                            | true     |
| çœ ç¼–ç       | provinceCode                            | true     |
| å¸‚           | cityName                                | true     |
| å¸‚ ç¼–ç       | cityCode                                | true     |
| åŒº           | districtName                            | true     |
| åŒº ç¼–ç       | districtCode                            | true     |
| è¯¦ç»†åœ°å€     | fullAddress                             | true     |
| è®¾ç½®é»˜è®¤åœ°å€ | isDefault (æ˜¯å¦é»˜è®¤åœ°å€ â†’ 0ï¼šå¦  1ï¼šæ˜¯) | false    |



**å®ç°æ­¥éª¤ï¼š**



1. åœ¨æ–°å¢æ”¶è´§åœ°å€é¡µé¢ `data` ä¸­å£°æ˜æ‰€éœ€è¦çš„å­—æ®µ
2. å®šä¹‰æ”¶è´§åœ°å€æ‰€éœ€è¦çš„å…¨éƒ¨æ¥å£ `API` å‡½æ•°



**è½åœ°ä»£ç ï¼š**



`â¡ï¸ modules/settingModule/pages/address/add/index`

```js
Page{{
  
  // é¡µé¢çš„åˆå§‹æ•°æ®
  data: {
	  name: '', // æ”¶è´§äºº
      phone: '', // æ‰‹æœºå·
      provinceName: '', // çœ
      provinceCode: '', // çœ ç¼–ç 
      cityName: '', // å¸‚
      cityCode: '', // å¸‚ ç¼–ç 
      districtName: '', // åŒº
      districtCode: '', // åŒº ç¼–ç 
      address: '',  // è¯¦ç»†åœ°å€
      fullAddress: '', // å®Œæ•´åœ°å€ (çœ + å¸‚ + åŒº + è¯¦ç»†åœ°å€)
      isDefault: 0 // è®¾ç½®é»˜è®¤åœ°å€ï¼Œæ˜¯å¦é»˜è®¤åœ°å€ â†’ 0ï¼šå¦  1ï¼šæ˜¯
  }
}}

```



`â¡ï¸ /api/address`

```js
import http from '../utils/http'

/**
 * @description å®ç°æ–°å¢æ”¶è´§åœ°å€
 * @param {*} data
 * @returns Promise
 */
export const reqAddAddress = (data) => {
  return http.post('/userAddress/save', data)
}

/**
 * @description è·å–æ”¶è´§åœ°å€åˆ—è¡¨
 * @returns Promise
 */
export const reqAddressList = () => {
  return http.get('/userAddress/findUserAddress')
}

/**
 * @description è·å–æ”¶è´§åœ°å€è¯¦æƒ…
 * @param {*} id æ”¶è´§åœ°å€id
 * @returns Promise
 */
export const reqAddressInfo = (id) => {
  return http.get(`/userAddress/${id}`)
}

/**
 * @description ç¼–è¾‘æ”¶è´§åœ°å€
 * @param {*} data
 * @returns Promise
 */
export const reqUpdateAddress = (data) => {
  return http.post('/userAddress/update', data)
}

/**
 * @description åˆ é™¤æ”¶è´§åœ°å€
 * @param {*} id æ”¶è´§åœ°å€ id
 * @returns Promise
 */
export const reqDelAddress = (id) => {
  return instance.get(`/userAddress/delete/${id}`)
}

```







### 02. æ”¶é›†çœå¸‚åŒºæ•°æ®



**æ€è·¯åˆ†æ**ï¼š



çœå¸‚åŒºçš„ç»“æ„ä½¿ç”¨äº†å°ç¨‹åºæœ¬èº«è‡ªå¸¦çš„`picker` ä»¶ï¼Œå¹¶å°†ç»„ä»¶çš„ `mode` å±æ€§è®¾ç½®ä¸ºäº† `region`ï¼Œä»è€Œå˜æˆçœå¸‚åŒºé€‰æ‹©å™¨

å¦‚æœæƒ³è·å–çœå¸‚åŒºçš„æ•°æ®ï¼Œéœ€è¦ç»™ `picker` é€‰æ‹©ç»„ä»¶æ·»åŠ `change` äº‹ä»¶æ¥ç›‘å¬å±æ€§å€¼çš„æ”¹å˜ï¼Œè·å–é€‰ä¸­çš„çœå¸‚åŒº



```html
<!-- çœå¸‚å¿ -->
<view class="item">
  <text class="label">çœ/å¸‚/å¿ (åŒº)</text>

  <!-- modeï¼šç»™ç»„ä»¶æ·»åŠ  mode å±æ€§è®¾ç½®ä¸ºäº† regionï¼Œä»è€Œå˜æˆçœå¸‚åŒºé€‰æ‹©å™¨ -->
  <!-- valueï¼šè¦æ±‚æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œè¡¨ç¤ºé€‰ä¸­çš„çœå¸‚åŒºï¼Œé»˜è®¤é€‰ä¸­æ¯ä¸€åˆ—çš„ç¬¬ä¸€ä¸ªå€¼ -->
  <!-- bindchangeï¼šæ¥ç›‘å¬å±æ€§å€¼çš„æ”¹å˜ï¼Œä¹Ÿå°±æ˜¯è·å–é€‰ä¸­çš„çœå¸‚åŒº -->
  <picker
    mode="region"
    value="{{ [provinceName, cityName, districtName] }}"
    bindchange="onAddressChange"
  >
    <view wx:if="{{ provinceName }}" class="region">
     {{ provinceName + ' ' + cityName + ' ' + districtName }}
    </view>
    <view wx:else class="placeholder">è¯·å¡«å†™æ”¶è´§äººæ‰€åœ¨åŸå¸‚</view>
  </picker>

  <view class="location" bindtap="onLocation">
    <van-icon name="location-o" color="#777" />
    <text>å®šä½</text>
  </view>
</view>
```



**å®ç°æ­¥éª¤**ï¼š



1. ç»™ `picker` é€‰æ‹©ç»„ä»¶æ·»åŠ `change` äº‹ä»¶æ¥ç›‘å¬å±æ€§å€¼çš„æ”¹å˜ï¼Œè·å–é€‰ä¸­çš„çœå¸‚åŒº
2. å°†è·å–åˆ°çœå¸‚åŒºæ ‡è¯†å’Œç¼–ç èµ‹å€¼ç»™ `data`ä¸­çš„å­—æ®µ



**è½åœ°ä»£ç **ï¼š



`â¡ï¸ modules/settingModule/pages/address/add/index`

```js
Page({
   
  // coding...
    
  // çœå¸‚åŒºé€‰æ‹©
  onAddressChange(event) {
    const [provinceCode, cityCode, districtCode] = event.detail.code
    const [provinceName, cityName, districtName] = event.detail.value

    // å­˜å‚¨çœå¸‚åŒºå¯¹åº”çš„ç¼–ç 
    this.setData({
      provinceCode,
      provinceName,
      cityCode,
      cityName,
      districtName,
      districtCode
    })
  }
    
  // coding...
})
```









### 03. æ”¶é›†æ–°å¢åœ°å€å…¶ä»–è¯·æ±‚å‚æ•°



**æ€è·¯åˆ†æï¼š**



ä½¿ç”¨ç®€æ˜“åŒå‘æ•°æ® `model:value` ç»‘å®šæ¥æ”¶é›†æ–°å¢åœ°å€è¡¨å•æ•°æ®ã€‚



åœ¨å°†æ•°æ®æ”¶é›†ä»¥åï¼Œéœ€è¦ç»„ç»‡ä¸¤ä¸ªæ•°æ®ï¼š

1. æ˜¯å¦æ˜¯é»˜è®¤åœ°å€ï¼Œ0 ä¸è®¾ç½®ä¸ºé»˜è®¤åœ°å€ï¼Œ1 è®¾ç½®ä¸ºé»˜è®¤åœ°å€
2. æ‹¼æ¥å®Œæ•´çš„æ”¶è´§åœ°å€



**å®ç°æ­¥éª¤ï¼š**



1. ä½¿ç”¨ç®€æ˜“åŒå‘æ•°æ®ç»‘å®šæ¥æ”¶é›†æ–°å¢åœ°å€è¡¨å•æ•°æ®ã€‚
3. ç»™æŒ‰é’®ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œåœ¨äº‹ä»¶å¤„ç†å‡½æ•°ä¸­æ”¶é›†å¹¶æ•´ç†æ•°æ®



**è½åœ°ä»£ç ï¼š**

```js
Page({
    
  // coding...
    
  // è·å–è¡¨å•å…ƒç´ çš„å€¼
  saveAddrssForm(event) {
      
    // è§£æ„å‡ºçœå¸‚åŒºä»¥åŠ æ˜¯å¦æ˜¯é»˜è®¤åœ°å€
    const { provinceName, cityName, districtName, address, isDefault } = this.data
    
    // æ‹¼æ¥å®Œæ•´çš„åœ°å€
    const fullAddress = provinceName + cityName + districtName + address
      
    // åˆå¹¶æ¥å£è¯·æ±‚å‚æ•°
    const params = {
      ...this.data,
      fullAddress,
      isDefault: isDefault ? 1 : 0
    }


    console.log(params)
  }
})
```









### 04. åœ°ç†å®šä½åŠŸèƒ½ä»‹ç»



**åœ°ç†å®šä½ä»‹ç»ï¼š**



å°ç¨‹åºåœ°ç†å®šä½æ˜¯æŒ‡é€šè¿‡å°ç¨‹åºå¼€å‘å¹³å°æä¾›çš„ `API`ï¼Œæ¥è·å–ç”¨æˆ·çš„åœ°ç†ä½ç½®ä¿¡æ¯ã€‚ç”¨æˆ·åœ¨ä½¿ç”¨å°ç¨‹åºæ—¶ï¼Œå¯ä»¥æˆæƒå°ç¨‹åºè·å–è‡ªå·±çš„åœ°ç†ä½ç½®ä¿¡æ¯

<img src="http://8.131.91.46:6677/mina/floor/åœ°å€æˆæƒæç¤º.jpg" style="zoom:50%; border: 1px solid #ccc" />



1. `wx.getLocation()` ï¼šè·å–å½“å‰çš„åœ°ç†ä½ç½®
2. `wx.chooseLocation()`ï¼šæ‰“å¼€åœ°å›¾é€‰æ‹©ä½ç½®



**ç”³è¯·å¼€é€šï¼š**



æš‚æ—¶åªå¯¹éƒ¨åˆ†ç±»ç›®çš„å°ç¨‹åºå¼€æ”¾ï¼Œéœ€è¦å…ˆé€šè¿‡ç±»ç›®å®¡æ ¸ï¼Œç„¶ååœ¨å°ç¨‹åºç®¡ç†åå°ï¼Œã€Œå¼€å‘ã€-ã€Œå¼€å‘ç®¡ç†ã€-ã€Œæ¥å£è®¾ç½®ã€ä¸­è‡ªåŠ©å¼€é€šè¯¥æ¥å£æƒé™ã€‚



**ä½¿ç”¨æ–¹æ³•ï¼š**



1. åœ¨ app.json ä¸­é…ç½® `requiredPrivateInfos` è¿›è¡Œå£°æ˜å¯ç”¨

2. åœ¨è°ƒç”¨ `wx.getLocation()` æ—¶éœ€è¦åœ¨ app.json é…ç½® `permission `å­—æ®µï¼ŒåŒæ—¶ä½¿ç”¨ `scope.userLocation` å£°æ˜**æ”¶é›†ç”¨æˆ·é€‰æ‹©çš„ä½ç½®ä¿¡æ¯**çš„ç›®çš„ï¼Œ`wx.chooseLocation()` æ¥å£ä¸éœ€è¦é…ç½®è¯¥å­—æ®µï¼Œå¯ä»¥ç›´æ¥è¿›è¡Œè°ƒç”¨
3. åœ¨é…ç½®å¥½ä»¥åï¼Œè°ƒç”¨ `wx.getLocation()` å’Œ `wx.chooseLocation()` æ¥å£



å‚è€ƒæ–‡æ¡£ï¼š

1. [åœ°ç†ä½ç½®æ¥å£æ–°å¢ä¸ç›¸å…³æµç¨‹è°ƒæ•´](https://developers.weixin.qq.com/community/develop/doc/000a02f2c5026891650e7f40351c01)
2. [permission å­—æ®µè¯´æ˜](https://developers.weixin.qq.com/miniprogram/dev/reference/configuration/app.html#permission)



åœ¨ `app.json` ä¸­è¿›è¡Œé…ç½®

```json
{
  "requiredPrivateInfos": [
    "getLocation",
    "chooseLocation"
  ],
  "permission": {
    "scope.userLocation": {
      "desc": "è·å–ç”¨æˆ·ä½ç½®ä¿¡æ¯ç”¨äºå¡«å†™æ”¶è´§åœ°å€"
    }
  }
}
```



**getLocation ä½¿ç”¨ï¼š**



```js
// åœ°ç†å®šä½
async onLocation() {
  // è·å– çº¬åº¦ ã€ç²¾åº¦
  const { latitude, longitude } = await wx.getLocation()
  console.log(location)
}
```



**chooseLocation ä½¿ç”¨ï¼š**

```js
// åœ°ç†å®šä½
async onLocation() {
  // æ‰“å¼€åœ°å›¾é€‰æ‹©ä½ç½®ï¼Œè·å– çº¬åº¦ ã€ç²¾åº¦
  const { latitude, longitude }  = await wx.chooseLocation()
  console.log(res)
}
```



<img src="http://8.131.91.46:6677/mina/floor/æˆæƒåœ°å€.jpg" style="zoom:30%; height: 2000px; border: 1px solid #ccc" />











### 05. æ‹’ç»æˆæƒåçš„è§£å†³æ–¹æ¡ˆ



<img src="http://8.131.91.46:6677/mina/floor/åœ°å€æˆæƒæç¤º.jpg" style="zoom:50%; border: 1px solid #ccc" />



åœ¨è°ƒç”¨ `wx.getLocation()` è·å–ç”¨åœ°ç†ä½ç½®æ—¶ï¼Œå¦‚æœç”¨æˆ·é€‰æ‹©æ‹’ç»æˆæƒï¼Œä»£ç ä¼šç›´æ¥æŠ›å‡ºé”™è¯¯ã€‚

åœ¨æ‹’ç»æˆæƒä»¥åï¼Œå†æ¬¡è°ƒç”¨ `wx.getLocation()` æ—¶ï¼Œå°±ä¸ä¼šåœ¨å¼¹çª—è¯¢é—®ç”¨æˆ·æ˜¯å¦å…è®¸æˆæƒã€‚



æ¥ä¸‹æ¥ï¼Œå°±éœ€è¦ä¼˜åŒ–æˆæƒçš„æµç¨‹ï¼š

<img src="http://8.131.91.46:6677/mina/floor/æ‹’ç»æˆæƒä»¥åçš„æ–¹æ¡ˆ.png" style="zoom:80%; border: 1px solid #ccc" />



1. `wx.getSetting()`ï¼šè·å–ç”¨æˆ·çš„å½“å‰è®¾ç½®ã€‚è¿”å›å€¼ä¸­åªä¼šå‡ºç°å°ç¨‹åºå·²ç»å‘ç”¨æˆ·è¯·æ±‚è¿‡çš„æƒé™
2. `wx.openSetting()`ï¼š è°ƒèµ·å®¢æˆ·ç«¯å°ç¨‹åºè®¾ç½®ç•Œé¢ï¼Œè¿”å›ç”¨æˆ·è®¾ç½®çš„æ“ä½œç»“æœ



> ğŸ“Œ **æ³¨æ„äº‹é¡¹ï¼š**
>
> 1. å¦‚æœå¸Œæœ›ç”¨æˆ·å†æ¬¡æˆæƒï¼Œå°±éœ€è¦è®©ç”¨æˆ·è¿›è¡Œ **æ‰‹åŠ¨å¼€å¯æˆæƒ**ã€‚
> 2. wx.openSetting() å¿…é¡»ç”¨æˆ·å‘ç”Ÿç‚¹å‡»è¡Œä¸ºåï¼Œæ‰å¯ä»¥è·³è½¬åˆ°è®¾ç½®é¡µè¿›è¡Œæˆæƒä¿¡æ¯ç®¡ç†ã€‚



```js
// è·å–ç”¨æˆ·åœ°ç†ä½ç½®ä¿¡æ¯
async onLocation() {
  // è°ƒç”¨ getSetting æ–¹æ³•è·å–ç”¨æˆ·æ‰€æœ‰çš„æˆæƒä¿¡æ¯
  // è¿”å›çš„ authSetting åŒ…å«å°ç¨‹åºå·²å‘å°ç¨‹åºç”³è¯·è¿‡çš„æƒé™å·²ç»æˆæƒç»“æœ(trueã€false)
  const { authSetting } = await wx.getSetting()
  console.log(authSetting)

  // scope.userLocation æ˜¯å¦å·²ç»æˆæƒè·å–åœ°ç†ä½ç½®çš„ä¿¡æ¯
  // å¦‚æœä¹‹å‰æ²¡æœ‰ç”³è¯·è¿‡è¿”å› undefinedï¼Œéœ€è¦è°ƒç”¨ getLocation
  // å¦‚æœä¹‹å‰åŒæ„äº†æˆæƒï¼Œè¿”å› trueï¼Œéœ€è¦è°ƒç”¨ getLocation
  // å¦‚æœä¹‹å‰æ‹’ç»äº†æˆæƒï¼Œè¿”å› falseï¼Œéœ€è¦ç”¨æˆ·æ‰‹åŠ¨è¿›è¡Œæˆæƒ
  // ç­‰äº trueï¼Œæˆ–è€…ä¸ç­‰äº undefinedï¼Œè¯´æ˜éœ€è¦è¿›è¡Œæˆæƒ
  // const isAuth =
  //   authSetting['scope.userLocation'] ||
  //   authSetting['scope.userLocation'] === undefined

  // ä¸ºäº†é¿å…å†—ä½™çš„æ¡ä»¶åˆ¤æ–­ï¼Œä½¿ç”¨ !! æŠŠä»£ç è¿›è¡Œä¼˜åŒ–
  const isAuth = !!authSetting['scope.userLocation']

  if (!isAuth) {
    // å¼¹çª—è¯¢é—®ç”¨æˆ·æ˜¯å¦è¿›è¡Œæˆæƒ
    const modalRes = await wx.modal({
      title: 'æˆæƒæç¤º',
      content: 'éœ€è¦éœ€è¦æ‚¨çš„åœ°ç†ä½ç½®ä¿¡æ¯ï¼Œè¯·ç¡®è®¤æˆæƒ'
    })

    // å¦‚æœç”¨æˆ·ç‚¹å‡»äº†å–æ¶ˆï¼Œè¯´æ˜ç”¨æˆ·æ‹’ç»äº†æˆæƒï¼Œç»™ç”¨æˆ·æç¤º
    if (!modalRes) return wx.toast({ title: 'æ‚¨æ‹’ç»äº†æˆæƒ' })

    // å¦‚æœç”¨æˆ·ç‚¹å‡»äº†ç¡®å®šï¼Œè°ƒç”¨ wx.openSetting æ‰“å¼€å¾®ä¿¡å®¢æˆ·ç«¯å°ç¨‹åºæˆæƒé¡µé¢
    // å¹¶è¿”å›æˆæƒä»¥åçš„ç»“æœ
    const { authSetting } = await wx.openSetting()

    // å¦‚æœç”¨æˆ·æ²¡æœ‰æ›´æ–°æˆæƒä¿¡æ¯ï¼Œæç¤ºæ²¡æœ‰æ›´æ–°æˆæƒ
    if (!authSetting['scope.userLocation'])
      return wx.toast({ title: 'æˆæƒå¤±è´¥ï¼' })

    try {
      // å¦‚æœç”¨æˆ·æ›´æ–°æˆæƒä¿¡æ¯ï¼Œåˆ™è°ƒç”¨ getLocation è·å–ç”¨æˆ·åœ°ç†ä½ç½®ä¿¡æ¯
      const locationRes = await wx.getLocation()
      // æ‰“å°åœ°ç†ä½ç½®ä¿¡æ¯
      console.log(locationRes)
    } catch (err) {
      console.log(err)
    }
  } else {
    try {
      // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨ getLocation æˆ–è€…ä¹‹å‰æˆæƒè¿‡
      // ç›´æ¥è°ƒç”¨ getLocation è·å–ç”¨æˆ·ä¿¡æ¯å³å¯
      const locationRes = await wx.getLocation()
      console.log(locationRes)
    } catch (error) {
      wx.toast({ title: 'æ‚¨æ‹’ç»æˆæƒè·å–åœ°å€ä½ç½®' })
    }
  }
}

```











### 06. å¼€é€šè…¾è®¯ä½ç½®æœåŠ¡



**è…¾è®¯ä½ç½®æœåŠ¡ç®€ä»‹ï¼š**

<img src="http://8.131.91.46:6677/mina/floor/å®šä½åŠŸèƒ½.png" style="zoom:80%; border: 1px solid #efefef" />

ä½¿ç”¨`wx.chooseLocation()`èƒ½å¤Ÿå¾ˆæ–¹ä¾¿çš„è®©ç”¨æˆ·æ¥é€‰æ‹©åœ°ç†ä½ç½®ï¼Œä½†æ˜¯`wx.chooseLocation()`è¿”å›çš„æ•°æ®å¹¶æ²¡æœ‰åŒ…å«çœå¸‚åŒºã€çœå¸‚åŒºç¼–ç æ•°æ®ã€‚è€Œæ–°å¢æ”¶è´§åœ°å€æ¥å£ï¼Œéœ€è¦ä¼ é€’çœå¸‚åŒºã€çœå¸‚åŒºç¼–ç æ•°æ®ã€‚



è¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ [è…¾è®¯ä½ç½®æœåŠ¡](https://lbs.qq.com/miniProgram/jsSdk/jsSdkGuide/jsSdkOverview) å°†è¿”å›çš„ç»åº¦ã€çº¬åº¦è¿›è¡Œé€†åœ°å€è§£æï¼Œè½¬æ¢æˆè¯¦ç»†åœ°å€ã€‚



[è…¾è®¯ä½ç½®æœåŠ¡](https://lbs.qq.com/miniProgram/jsSdk/jsSdkGuide/jsSdkOverview)ä¸“ä¸ºå°ç¨‹åºå¼€å‘æä¾›äº† JavaScript SDKï¼Œæ–¹ä¾¿å¼€å‘è€…åœ¨å°ç¨‹åºä¸­å¯ä»¥ä½¿ç”¨è…¾è®¯åœ°å›¾æœåŠ¡ã€‚

ä½¿ç”¨[è…¾è®¯ä½ç½®æœåŠ¡](https://lbs.qq.com/miniProgram/jsSdk/jsSdkGuide/jsSdkOverview)å¯ä»¥å¾ˆæ–¹ä¾¿çš„è®©å¼€å‘è€…å®ç°åœ°å€è§£æã€é€†åœ°å€è§£æç­‰åŠŸèƒ½ã€‚



<img src="http://8.131.91.46:6677/mina/floor/è…¾è®¯ä½ç½®æœåŠ¡.jpg" style="zoom:80%;border: 1px solid #ccc" />



**ä½¿ç”¨æ­¥éª¤ï¼š**



1. ç”³è¯·å¼€å‘è€…å¯†é’¥ï¼ˆkeyï¼‰ï¼š[ç”³è¯·å¯†é’¥](https://lbs.qq.com/dev/console/application/mine)
2. å¼€é€š  webserviceAPI  æœåŠ¡ï¼šæ§åˆ¶å° â†’ åº”ç”¨ç®¡ç†â†’[æˆ‘çš„åº”ç”¨](https://lbs.qq.com/dev/console/key/manage) â†’ æ·»åŠ  key â†’å‹¾é€‰  WebServiceAPI â†’ä¿å­˜
3. ä¸‹è½½å¾®ä¿¡å°ç¨‹åº JavaScriptSDKï¼Œå¾®ä¿¡å°ç¨‹åº[JavaScriptSDK v1.1](https://mapapi.qq.com/web/miniprogram/JSSDK/qqmap-wx-jssdk1.1.zip)  [JavaScriptSDK v1.2](https://mapapi.qq.com/web/miniprogram/JSSDK/qqmap-wx-jssdk1.2.zip)
4. å®‰å…¨åŸŸåè®¾ç½®
   - åœ¨[å°ç¨‹åºç®¡ç†åå°](https://mp.weixin.qq.com/wxamp/home/guide) -> å¼€å‘ -> å¼€å‘ç®¡ç† -> å¼€å‘è®¾ç½® -> â€œæœåŠ¡å™¨åŸŸåâ€ ä¸­è®¾ç½® request åˆæ³•åŸŸå
   - æ·»åŠ  https://apis.map.qq.com



**è¯¦ç»†æ­¥éª¤ï¼š**



1. ç”³è¯·å¯†é’¥ï¼š[å¯†é’¥ç”³è¯·](https://lbs.qq.com/dev/console/application/mine)ï¼Œå¾®ä¿¡æ‰«ç è¿›è¡Œç™»å½•ï¼Œé€‰æ‹©ç»‘å®šå·²æœ‰è´¦å·ã€æˆ–è€…æ³¨å†Œæ–°è´¦å· (éœ€è¦ç»‘å®šæ‰‹æœºã€éªŒè¯é‚®ç®±)

2. æ§åˆ¶å° â†’ åº”ç”¨ç®¡ç†â†’[æˆ‘çš„åº”ç”¨](https://lbs.qq.com/dev/console/key/manage) â†’ åˆ›å»ºåº”ç”¨ â†’ æ·»åŠ  key  â†’  åˆ›å»ºå®Œæˆ

   <img src="http://8.131.91.46:6677/mina/floor/åˆ›å»ºåº”ç”¨.jpg" style="zoom:60%;" />

   <img src="http://8.131.91.46:6677/mina/floor/æ·»åŠ  key.jpg" style="zoom:76%; border: 1px solid #ccc" />

   

3. ä¸‹è½½å¾®ä¿¡å°ç¨‹åº [JavaScriptSDK v1.2](https://mapapi.qq.com/web/miniprogram/JSSDK/qqmap-wx-jssdk1.2.zip)ï¼Œä¸‹è½½å°† `.js` æ–‡ä»¶æ”¾åˆ°å°ç¨‹åºçš„ `libs` ç›®å½•ä¸‹

4. è¿›è¡Œå®‰å…¨åŸŸåè®¾ç½®ï¼Œæˆ–è€…ç‚¹å‡»å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­çš„æš‚æ—¶ä¸æ ¡éªŒåŸŸå







### 07. LBS é€†åœ°å€è§£æ



**ä½¿ç”¨æ­¥éª¤ï¼š**



1. åœ¨é¡¹ç›®ä¸­å¼•å…¥ SDK æ ¸å¿ƒç±»
2. åœ¨ `onLoad` ä¸­å®ä¾‹åŒ– API æ ¸å¿ƒç±»ï¼ŒåŒæ—¶é…ç½®åˆ›å»ºçš„ key
3. ä½¿ç”¨å®ä¾‹æ–¹æ³• `reverseGeocoder` æ–¹æ³•è¿›è¡Œé€†åœ°å€è§£æï¼Œå°†æä¾›çš„åæ ‡è½¬æ¢ä¸ºè¯¦ç»†çš„åœ°å€ä½ç½®ä¿¡æ¯



[å®˜æ–¹æ–‡æ¡£-åŸºç¡€ç¤ºä¾‹ï¼šHello World](https://lbs.qq.com/miniProgram/jsSdk/jsSdkGuide/jsSdkOverview)

[å®˜æ–¹æ–‡æ¡£-é€†åœ°å€è§£æï¼šreverseGeocoder](https://lbs.qq.com/miniProgram/jsSdk/jsSdkGuide/methodReverseGeocoder)



**è½åœ°ä»£ç ï¼š**



1. å¼•å…¥ SDK æ ¸å¿ƒç±»

   ```js
   // var QQMapWX = require('../../libs/qqmap-wx-jssdk.js');
   import QQMapWX from '../../../../../libs/qqmap-wx-jssdk.min'
   ```

   

2. å®ä¾‹åŒ– API æ ¸å¿ƒç±»

   ```js
   // å¼•å…¥SDKæ ¸å¿ƒç±»ï¼Œjsæ–‡ä»¶æ ¹æ®è‡ªå·±ä¸šåŠ¡ï¼Œä½ç½®å¯è‡ªè¡Œæ”¾ç½®
   import QQMapWX from '../../../../../libs/qqmap-wx-jssdk.min'
   
   Page({
    
     onLoad: function () {
   
       // å®ä¾‹åŒ–APIæ ¸å¿ƒç±»
       this.qqmapsdk = new QQMapWX({
         key: 'ç”³è¯·çš„key'
       })
    
     }
       
     // coding...   
   }
   ```

   

3. ä½¿ç”¨ `reverseGeocoder` æ–¹æ³•è¿›è¡Œé€†åœ°å€è§£æï¼Œå°†æä¾›çš„åæ ‡è½¬æ¢ä¸ºæ‰€åœ¨ä½ç½®çš„æ–‡å­—æè¿°çš„è½¬æ¢

   ```js
   // LBS åœ°å€é€†è§£æ
   // åœ°ç†å®šä½
   async onLocation() {
     // è·å– çº¬åº¦ ã€ç²¾åº¦
     // const { latitude, longitude } = await wx.getLocation()
     // console.log(location)
   
     // è·å–ç»ã€çº¬åº¦ã€ä½ç½®åç§°
     let { latitude, longitude, name } = await wx.chooseLocation()
   
     // ä½¿ç”¨ reverseGeocoder æ–¹æ³•è¿›è¡Œé€†åœ°å€è§£æ
     this.qqmapsdk.reverseGeocoder({
       // ä¼ å…¥ç»ã€çº¬åº¦
       location: {
         latitude,
         longitude
       },
   
       // é€†åœ°å€è§£ææˆåŠŸåæ‰§è¡Œ
       success: (res) => {
         // è·å–é€‰æ‹©çš„
         const { street_number } = res.result.address_component
   
         // province çœ  city å¸‚  district åŒº
         const {
           province, // çœ
           city, // å¸‚
           district, // åŒº
           adcode, // è¡Œæ”¿åŒºåˆ’ä»£ç 
           city_code, // åŸå¸‚ä»£ç ï¼Œç”±å›½å®¶ç +è¡Œæ”¿åŒºåˆ’ä»£ç ï¼ˆæå‡ºåŸå¸‚çº§åˆ«ï¼‰ç»„åˆè€Œæ¥ï¼Œæ€»å…±ä¸º9ä½
           nation_code // å›½å®¶ä»£ç 
         } = res.result.ad_info
   
         this.setData({
           // çœçº§: å‰ä¸¤ä½æœ‰å€¼ï¼Œå4ä½ç½®0ï¼Œå¦‚ï¼Œæ²³åŒ—çœ: 130000
           provinceCode: adcode.replace(adcode.substring(2, 6), '0000'),
           provinceName: province,
   
           // å¸‚å‰é¢å¤šä¸ªå›½å®¶ä»£ç ï¼Œéœ€è¦è¿›è¡Œæˆªå–
           cityCode: city_code.slice(nation_code.length),
           cityName: city,
   
           // ä¸œèå¸‚ã€ä¸­å±±å¸‚ã€ä¿®å·å¸‚ã€å˜‰å…³å¸‚ å› å…¶ä¸‹æ— åŒºå¿çº§ï¼Œ
           districtCode: district && adcode,
           districtName: district,
   
           // è¯¦ç»†åœ°å€
           address: name,
           fullAddress: [province, city, district, address].join('')
         })
       }
     })
   }
   ```





### 08. async-validator åŸºæœ¬ä½¿ç”¨



**çŸ¥è¯†ç‚¹**ï¼š



`async-validator`æ˜¯ä¸€ä¸ªåŸºäº `JavaScript` çš„è¡¨å•éªŒè¯åº“ï¼Œæ”¯æŒå¼‚æ­¥éªŒè¯è§„åˆ™å’Œè‡ªå®šä¹‰éªŒè¯è§„åˆ™

ä¸»æµçš„ `UI` ç»„ä»¶åº“ `Ant-design` å’Œ `Element`ä¸­çš„è¡¨å•éªŒè¯éƒ½æ˜¯åŸºäº `async-validator`

ä½¿ç”¨ `async-validator` å¯ä»¥æ–¹ä¾¿åœ°æ„å»ºè¡¨å•éªŒè¯é€»è¾‘ï¼Œä½¿å¾—é”™è¯¯æç¤ºä¿¡æ¯æ›´åŠ å‹å¥½å’Œçµæ´»ã€‚



**ä½¿ç”¨æ­¥éª¤ï¼š**

1. å®‰è£…å¹¶åœ¨é¡¹ç›®ä¸­å¯¼å…¥ `async-validator`
2. åˆ›å»ºéªŒè¯è§„åˆ™
3. åˆ›å»ºè¡¨å•éªŒè¯å®ä¾‹ï¼Œå°†éªŒè¯è§„åˆ™ä¼ é€’ç»™æ„é€ å‡½æ•°ï¼Œäº§ç”Ÿå®ä¾‹
4. è°ƒç”¨å®ä¾‹æ–¹æ³• `validate` å¯¹æ•°æ®è¿›è¡ŒéªŒè¯
   - ç¬¬ä¸€ä¸ªå‚æ•°ï¼šéœ€è¦éªŒè¯çš„æ•°æ®
   - ç¬¬äºŒä¸ªå‚æ•°ï¼šå›è°ƒå‡½æ•°ï¼Œå›è°ƒå‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•° errors, fields
     - errorsï¼šå¦‚æœéªŒè¯æˆåŠŸï¼Œè¿”å› nullï¼ŒéªŒè¯é”™è¯¯ï¼Œè¿”å›æ•°ç»„
     - fieldsï¼šéœ€è¦éªŒè¯çš„å­—æ®µï¼Œå±æ€§å€¼é”™è¯¯æ•°ç»„



**è½åœ°ä»£ç ï¼š**

1. å®‰è£… `async-validator`

   ```shell
   npm i async-validator
   ```

   

2. å¼€å‘è€…å·¥å…·ï¼Œç‚¹å‡»æ„å»º `npm`ï¼Œå¯¹  `async-validator` è¿›è¡Œæ„å»º

3. åœ¨ js æ–‡ä»¶ä¸­å¯¼å…¥ `async-validator`

   ```js
   // 1ï¸âƒ£ å¼•å…¥ async-validatorï¼Œasync-validator æä¾›äº†ä¸€ä¸ªæ„é€ å‡½æ•°
   import Schema from 'async-validator'
   
   Page({
     // 2ï¸âƒ£å®šä¹‰éœ€è¦éªŒè¯çš„æ•°æ®
     data: {
       name: 'ä½ å¥½'
     },
   
     // éªŒè¯æ•°æ®
     onValidate() {
       // 3ï¸âƒ£åˆ›å»ºè¡¨å•éªŒè¯è§„åˆ™
       const rules = {
         // key å»ºè®®å’Œ éœ€è¦éªŒè¯çš„æ•°æ®å­—æ®µåå­—ä¿æŒä¸€è‡´
         name: [
           // required æ˜¯å¦æ˜¯å¿…å¡«é¡¹
           { required: true, message: 'name ä¸èƒ½ä¸ºç©º' },
   
           // type æ•°æ®çš„ç±»å‹
           // message å¦‚æœéªŒè¯å¤±è´¥ï¼Œæç¤ºçš„é”™è¯¯å†…å®¹
           { type: 'string', message: 'name ä¸æ˜¯å­—ç¬¦ä¸²' },
   
           // min æœ€å°‘ä½æ•°ï¼Œmax æœ€å¤§ä½æ•°
           { min: 2, max: 5, message: 'åå­—æœ€å°‘ 2 ä¸ªå­—ï¼Œæœ€å¤š 5 ä¸ªå­—' }
   
           // æ­£åˆ™è¡¨è¾¾å¼
           // { pattern: '', message: '' }
   
           // è‡ªå®šä¹‰éªŒè¯è§„åˆ™
           // { validator: () => {} }
         ]
       }
   
       // 4ï¸âƒ£åˆ›å»ºè¡¨å•éªŒè¯å®ä¾‹
       // åœ¨åˆ›å»ºå®ä¾‹æ—¶éœ€è¦ä¼ å…¥éªŒè¯è§„åˆ™
       const validator = new Schema(rules)
   
       // 5ï¸âƒ£ è°ƒç”¨ validate å®ä¾‹æ–¹æ³•å¯¹æ•°æ®è¿›è¡ŒéªŒè¯
       // validate æ–¹æ³•æ¥æ”¶ä¸€ä¸ªå¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œå¯¹è±¡æ˜¯éœ€è¦éªŒè¯çš„æ•°æ®
       // æ³¨æ„ï¼švalidate æ–¹æ³•åªä¼šéªŒè¯å’ŒéªŒè¯è§„åˆ™åŒåçš„å±æ€§
       validator.validate(this.data, (errors, fields) => {
      // å¦‚æœéªŒè¯å¤±è´¥ï¼Œerrors æ˜¯æ‰€æœ‰é”™è¯¯çš„æ•°ç»„
         // å¦‚æœéªŒè¯æˆåŠŸï¼Œerrors æ˜¯ null
         console.log(errors)
   
         // fields æ˜¯éœ€è¦éªŒè¯çš„å±æ€§ï¼Œå±æ€§å€¼æ˜¯æ•°ç»„ï¼Œæ•°ç»„ä¸­åŒ…å«é”™è¯¯ä¿¡æ¯
         console.log(fields)
   
         if (errors) {
           console.log('éªŒè¯æ²¡æœ‰é€šè¿‡')
           console.log(errors)
           return
         }
   
         console.log('éªŒè¯é€šè¿‡')
       })
     }
   })
   
   ```
   
   





### 09. æ–°å¢æ”¶è´§åœ°å€è¡¨å•éªŒè¯



**æ€è·¯åˆ†æï¼š**



åœ¨ç‚¹å‡»æ–°å¢æ”¶è´§åœ°å€çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ç”¨æˆ·è¾“å…¥çš„å€¼è¿›è¡ŒéªŒè¯ã€‚äº§å“éœ€æ±‚å¦‚ä¸‹ï¼š



1. æ”¶è´§äººä¸èƒ½ä¸ºç©ºï¼Œä¸”ä¸èƒ½è¾“å…¥ç‰¹æ®Šå­—ç¬¦
2. æ‰‹æœºå·ä¸èƒ½ä¸ºç©ºï¼Œä¸”è¾“å…¥çš„æ‰‹æœºå·å¿…é¡»åˆæ³•
3. çœå¸‚åŒºä¸èƒ½ä¸ºç©º
4. è¯¦ç»†åœ°å€ä¸èƒ½ä¸ºç©º



æ­£åˆ™ï¼š

```js
// éªŒè¯æ”¶è´§äººï¼Œæ˜¯å¦åªåŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œä¸­æ–‡å­—ç¬¦
const nameRegExp = '^[a-zA-Z\\d\\u4e00-\\u9fa5]+$'

// éªŒè¯æ‰‹æœºå·ï¼Œæ˜¯å¦ç¬¦åˆä¸­å›½å¤§é™†æ‰‹æœºå·ç çš„æ ¼å¼
const phoneReg = '^1(?:3\\d|4[4-9]|5[0-35-9]|6[67]|7[0-8]|8\\d|9\\d)\\d{8}$'
```





**å®ç°æ­¥éª¤ï¼š**



1. åˆ›å»º `validateForm` æ–¹æ³•ï¼Œä½¿ç”¨ `async-validator` å¯¹è¡¨å•è¿›è¡ŒéªŒè¯
2. åœ¨æ–°å¢æ”¶è´§åœ°å€ä¹‹å‰ï¼Œè°ƒç”¨ `validateForm` æ–¹æ³•ï¼Œå¦‚æœéªŒè¯æˆåŠŸæ‰§è¡Œæ–°å¢å®ˆæŠ¤åœ°å€çš„é€»è¾‘



**è½åœ°ä»£ç ï¼š**



 `â¡ï¸ /modules/settingModule/pages/address/add/index` 

```js
import Schema from 'async-validator'

Page({

  // coding....

    // ä¿å­˜æ”¶è´§åœ°å€
  async saveAddrssForm() {
    // ç»„ç»‡å‚æ•° (å®Œæ•´åœ°å€ã€æ˜¯å¦è®¾ç½®ä¸ºé»˜è®¤åœ°å€)

    const {
      provinceName,
      cityName,
      districtName,
      address,
      isDefault
    } = this.data

    // æœ€ç»ˆéœ€è¦å‘é€çš„è¯·æ±‚å‚æ•°
    const params = {
      ...this.data,
      fullAddress: provinceName + cityName + districtName + address,
      isDefault: isDefault ? 1 : 0
    }

    // è°ƒç”¨æ–¹æ³•å¯¹æœ€ç»ˆçš„è¯·æ±‚å‚æ•°è¿›è¡ŒéªŒè¯
    const { valid } = await this.validateAddress(params)

    // å¦‚æœéªŒè¯æ²¡æœ‰é€šè¿‡ï¼Œä¸ç»§ç»­æ‰§è¡Œåç»­çš„é€»è¾‘
    if (!valid) return
    
    console.log(params)
  },

  // éªŒè¯æ–°å¢æ”¶è´§åœ°å€è¯·æ±‚å‚æ•°
  // å½¢å‚ params æ˜¯éœ€è¦éªŒè¯çš„æ•°æ®
  validateAddress(params) {
    // éªŒè¯æ”¶è´§äººï¼Œæ˜¯å¦åªåŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œä¸­æ–‡å­—ç¬¦
    const nameRegExp = '^[a-zA-Z\\d\\u4e00-\\u9fa5]+$'

    // éªŒè¯æ‰‹æœºå·
    const phoneReg = '^1(?:3\\d|4[4-9]|5[0-35-9]|6[67]|7[0-8]|8\\d|9\\d)\\d{8}$'

    // åˆ›å»ºéªŒè¯è§„åˆ™ï¼ŒéªŒè¯è§„åˆ™æ˜¯ä¸€ä¸ªå¯¹è±¡
    // æ¯ä¸€é¡¹æ˜¯ä¸€ä¸ªéªŒè¯è§„åˆ™ï¼ŒéªŒè¯è§„åˆ™å±æ€§éœ€è¦å’ŒéªŒè¯çš„æ•°æ®è¿›è¡ŒåŒå
    const rules = {
      name: [
        { required: true, message: 'è¯·è¾“å…¥æ”¶è´§äººå§“å' },
        { pattern: nameRegExp, message: 'æ”¶è´§äººå§“åä¸åˆæ³•' }
      ],
      phone: [
        { required: true, message: 'è¯·è¾“å…¥æ”¶è´§äººæ‰‹æœºå·' },
        { pattern: phoneReg, message: 'æ‰‹æœºå·ä¸åˆæ³•' }
      ],
      provinceName: { required: true, message: 'è¯·é€‰æ‹©æ”¶è´§äººæ‰€åœ¨åœ°åŒº' },
      address: { required: true, message: 'è¯·è¾“å…¥è¯¦ç»†åœ°å€' }
    }

    // åˆ›å»ºéªŒè¯å®ä¾‹ï¼Œå¹¶ä¼ å…¥éªŒè¯è§„åˆ™
    const validator = new Schema(rules)

    // è°ƒç”¨å®ä¾‹æ–¹æ³•å¯¹æ•°æ®è¿›è¡ŒéªŒè¯
    // æ³¨æ„ï¼šæˆ‘ä»¬å¸Œæœ›å°†éªŒè¯ç»“æœé€šè¿‡ Promsie çš„å½¢å¼è¿”å›ç»™å‡½æ•°çš„è°ƒç”¨è€…
    return new Promise((resolve) => {
      validator.validate(params, (errors, fields) => {
        if (errors) {
          // å¦‚æœéªŒè¯å¤±è´¥ï¼Œéœ€è¦ç»™ç”¨æˆ·è¿›è¡Œæç¤º
          wx.toast({
            title: errors[0].message
          })

          resolve({ valid: false })
        } else {
          resolve({ valid: true })
        }
      })
    })
  },


  // coding...
})
```





### 10. å®ç°æ–°å¢æ”¶è´§åœ°å€



**æ€è·¯åˆ†æï¼š**



åœ¨å®ç°äº†æ–°å¢æ”¶è´§åœ°å€çš„æ•°æ®æ”¶é›†ã€è¡¨å•éªŒè¯ä»¥åï¼Œæˆ‘ä»¬éœ€è¦å®ç°æ–°å¢æ”¶è´§åœ°å€çš„åŠŸèƒ½ï¼Œå°†ç”¨æˆ·çš„æ”¶è´§åœ°å€åˆ°æœåŠ¡å™¨ã€‚æˆ‘ä»¬ç›´æ¥æ ¹æ®æ¥å£æ–‡æ¡£ï¼Œå°è£…æ¥å£ `API`ï¼Œç„¶ååœ¨è¡¨å•éªŒè¯ä»¥åï¼Œè¿›è¡Œæ”¶è´§åœ°å€çš„æ·»åŠ å³å¯ã€‚



**å®ç°æ­¥éª¤ï¼š**



1. åœ¨å¯¹æ–°å¢æ”¶è´§åœ°å€è¯·æ±‚å‚æ•°éªŒè¯ä»¥åï¼Œå°†å°è£…å¥½çš„æ–°å¢æ”¶è´§åœ°å€çš„ `API` å‡½æ•°è°ƒç”¨

2. åœ¨æ–°å¢æ”¶è´§åœ°å€æˆåŠŸä»¥åï¼Œè·³è½¬åˆ°æ”¶è´§åœ°å€è¯¦æƒ…é¡µé¢ã€‚



**è½åœ°ä»£ç ï¼š**



`â¡ï¸ /pages/address/add/index.js` 

```js
// æ–°å¢æˆ–ä¿®æ”¹åœ°å€
async saveAddrssForm(event) {
  // ç»„ç»‡å‚æ•° (å®Œæ•´åœ°å€ã€æ˜¯å¦è®¾ç½®ä¸ºé»˜è®¤åœ°å€)
  const {
    provinceName,
    cityName,
    districtName,
    address,
    isDefault
  } = this.data

  // æœ€ç»ˆéœ€è¦å‘é€çš„è¯·æ±‚å‚æ•°
  const params = {
    ...this.data,
    fullAddress: provinceName + cityName + districtName + address,
    isDefault: isDefault ? 1 : 0
  }
  
  // å¦‚æœéªŒè¯æ²¡æœ‰é€šè¿‡ï¼Œä¸è¿›è¡Œåç»­å¤„ç†
  if (!valid) return

  // å‘é€è¯·æ±‚ï¼Œä¿å­˜æ”¶è´§åœ°å€
  const res = await reqAddAddress(params)
  
  if (res.code === 200) {
    wx.navigateBack({
      success() {
        wx.toast({ title: 'æ–°å¢æ”¶è´§åœ°å€æˆåŠŸ' })
      }
    })
  }
    
}
```









### 11. æ”¶è´§åœ°å€åˆ—è¡¨æ¸²æŸ“



**æ€è·¯åˆ†æï¼š**



æ¸²æŸ“æ”¶è´§åœ°å€éœ€è¦æ”¶è´§åœ°å€çš„æ•°æ®ï¼Œéœ€è¦è°ƒç”¨æ¥å£è·å–æ”¶è´§åœ°å€æ•°æ®ï¼Œä½¿ç”¨è¿”å›çš„æ•°æ®è¿›è¡Œç»“æ„çš„æ¸²æŸ“ã€‚



å…ˆç†Ÿæ‚‰æ¥å£æ–‡æ¡£ï¼š[è·å–æ”¶è´§åœ°å€](http://39.98.123.211:8300/doc.html#/webApi/ç”¨æˆ·åœ°å€æ¥å£/findUserAddressUsingGET) 



åœ¨ç†Ÿæ‚‰äº†æ¥å£æ–‡æ¡£ä»¥åï¼Œæ ¹æ®æ¥å£æ–‡æ¡£å°è£…æ¥å£ `API` å‡½æ•°ï¼Œç„¶ååœ¨é¡µé¢è°ƒç”¨ `API` å‡½æ•°è·å–æ”¶è´§åœ°å€çš„æ•°æ®ï¼Œåœ¨è·å–åˆ°æ•°æ®ä»¥åï¼Œä½¿ç”¨åç«¯è¿”å›çš„æ•°æ®å¯¹é¡µé¢è¿›è¡Œæ¸²æŸ“ã€‚



**å®ç°æ­¥éª¤ï¼š**



1. åœ¨ `onShow` é’©å­å‡½æ•°ä¸­è°ƒç”¨`reqAddressList`æ–¹æ³•

2. åœ¨è·å–åˆ°æ•°æ®ä»¥åï¼Œä½¿ç”¨åç«¯è¿”å›çš„æ•°æ®å¯¹é¡µé¢è¿›è¡Œæ¸²æŸ“



**è½åœ°ä»£ç ï¼š**



`â¡ï¸ /modules/settingModule/pages/address/list/index.js`

```js
// pages/address/list/index.js
+ import { reqAddressList } from '../../../../../api/address'

Page({
  // é¡µé¢çš„åˆå§‹æ•°æ®
  data: {
+     addressList: [] // æ”¶è´§åœ°å€åˆ—è¡¨
  },

+   // è·å–æ”¶è´§åœ°å€
+   async getAddressList() {
+     // è°ƒç”¨ APIï¼Œè·å–æ”¶è´§åœ°å€
+     const { data: addressList } = await reqAddressList()
+ 
+     this.setData({
+       addressList
+     })
+   },

  // å»ç¼–è¾‘é¡µé¢
  toEdit() {
    wx.navigateTo({
      url: '/modules/settingModule/pages/address/add/index'
    })
  },

+   onLoad() {
+     this.getAddressList()
+   }
})

```



`â¡ï¸ /modules/settingModule/pages/address/list/index.wxml`

```html
<view class="list-warpper" wx:if="{{ addressList.length }}">
  <view wx:for="{{ addressList }}" wx:key="id" class="list-item">
    <van-swipe-cell right-width="{{ 65 }}">
      <view class="list-item-box">
        <view class="info">
          <view class="user-info">
+             <text>{{ item.name }}</text>
+             <text>{{ item.phone }}</text>
+             <text wx:if="{{ item.isDefault }}" class="default-tag">é»˜è®¤</text>
          </view>

+           <view class="address-info"> {{ item.fullAddress }} </view>
        </view>

        <view class="editBtn">
          <van-icon bindtap="toEdit" name="edit" size="22px" color="#999" />
        </view>
      </view>
      <!-- <van-icon name="delete" size="22px" color="#999" /> -->
      <view slot="right" class="van-swipe-cell__right">
        <text>åˆ é™¤</text>
      </view>
    </van-swipe-cell>
  </view>
</view>
```







### 12. å®ç°æ›´æ–°æ”¶è´§åœ°å€



**æ€è·¯åˆ†æï¼š**



æ–°å¢å’Œç¼–è¾‘æ”¶è´§åœ°å€é¡µé¢æ˜¯åŒä¸€ä¸ªé¡µé¢ï¼Œæˆ‘ä»¬éœ€è¦åœ¨è¿™ä¸ªé¡µé¢å¤„ç†æ–°å¢å’Œç¼–è¾‘åŠŸèƒ½



åœ¨æ”¶è´§åœ°å€åˆ—è¡¨é¡µé¢ï¼Œç‚¹å‡»æ›´æ–°æŒ‰é’®æ—¶ï¼Œéœ€è¦è·³è½¬åˆ°æ–°å¢/æ›´æ–°é¡µé¢ï¼ŒåŒæ—¶éœ€è¦å°†æ›´æ–°è¿™ä¸€é¡¹çš„ `id` ä¼ é€’ç»™æ–°å¢/æ›´æ–°é¡µé¢ã€‚



åœ¨ `onLoad` ä¸­è·å– `id`ï¼Œå¹¶ä¸”ä½¿ç”¨ `id ` åŒºåˆ†ç”¨æˆ·æ˜¯è¿›è¡Œæ–°å¢è¿˜æ˜¯ç¼–è¾‘çš„æ“ä½œã€‚

å¦‚æœå­˜åœ¨ `id`ï¼Œåœ¨è·å–éœ€è¦æ›´æ–°çš„æ”¶è´§åœ°å€çš„æ•°æ®ï¼Œå¹¶è¿›è¡Œé¡µé¢çš„å›æ˜¾ç”¨æˆ·çš„æ”¶è´§åœ°å€ï¼Œå¹¶ä¸”éœ€è¦æ›´æ–°å¯¼èˆªæ æ ‡é¢˜

å› ä¸ºæˆ‘ä»¬ä¹‹å‰ç›´æ¥æ˜¯å°†æ•°æ®æ”¾åˆ° `data` ä¸­çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥å°†æ•°æ®ä½¿ç”¨ `setData` èµ‹å€¼å³å¯



é¦–å…ˆç†Ÿæ‚‰æ¥å£æ–‡æ¡£ï¼š[è·å–æ”¶è´§åœ°å€è¯¦æƒ…](http://39.98.123.211:8300/doc.html#/webApi/ç”¨æˆ·åœ°å€æ¥å£/getUsingGET) 





**å®ç°æ­¥éª¤ï¼š**



1. åœ¨ä»æ”¶è´§åœ°å€åˆ—è¡¨é¡µé¢è·³è½¬åˆ°æ›´æ–°é¡µé¢çš„æ—¶å€™ï¼Œéœ€è¦æºå¸¦ `id`
2. åœ¨ `onLoad` ä¸­åˆ¤æ–­æ˜¯å¦å­˜åœ¨ `id`ï¼Œå¦‚æœå­˜åœ¨ `id`ï¼Œåœ¨è·å–æ•°æ®è¿›è¡Œå›æ˜¾



**è½åœ°ä»£ç ï¼š**



`â¡ï¸ /modules/settingModule/pages/address/list/index.wxml`

```html
<!-- ç¼–è¾‘ã€åˆ é™¤æŒ‰é’® -->
<van-icon bindtap="toEdit" data-id="{{ item.id }}" name="edit" size="22px" color="#999" />
```



`â¡ï¸ /modules/settingModule/pages/address/list/index.js`

```js
// å»ç¼–è¾‘é¡µé¢
toEdit(event) {
  // éœ€è¦ç¼–è¾‘çš„æ”¶è´§åœ°å€
  const { id } = event.target.dataset

  wx.navigateTo({
    url: `/modules/settingModule/pages/address/add/index?id=${id}`
  })
}

```



`â¡ï¸ /modules/settingModule/pages/address/add/index.js`

```js
Page({
   
  // coding...
    
  // ä¿å­˜æ”¶è´§åœ°å€
  async saveAddrssForm() {
    // ç»„ç»‡å‚æ•° (å®Œæ•´åœ°å€ã€æ˜¯å¦è®¾ç½®ä¸ºé»˜è®¤åœ°å€)
    const {
      provinceName,
      cityName,
      districtName,
      address,
      isDefault
    } = this.data

    // æœ€ç»ˆéœ€è¦å‘é€çš„è¯·æ±‚å‚æ•°
    const params = {
      ...this.data,
      fullAddress: provinceName + cityName + districtName + address,
      isDefault: isDefault ? 1 : 0
    }

    // è°ƒç”¨æ–¹æ³•å¯¹æœ€ç»ˆçš„è¯·æ±‚å‚æ•°è¿›è¡ŒéªŒè¯
    const { valid } = await this.validateAddress(params)

    // å¦‚æœéªŒè¯æ²¡æœ‰é€šè¿‡ï¼Œä¸ç»§ç»­æ‰§è¡Œåç»­çš„é€»è¾‘
    if (!valid) return

+     // å‘é€è¯·æ±‚ï¼Œä¿å­˜æ”¶è´§åœ°å€
+     const res = this.addressId
+       ? await reqUpdateAddress(params)
+       : await reqAddAddress(params)

+     if (res.code === 200) {
+       // æç¤ºç”¨æˆ·æ›´æ–°çŠ¶æ€
+       wx.toast({
+         title: this.addressId ? 'ç¼–è¾‘æ”¶è´§åœ°å€æˆåŠŸ' : 'æ–°å¢æ”¶è´§åœ°å€æˆåŠŸ'
+       })
+ 
+       // è¿”å›åˆ°æ”¶è´§åœ°å€åˆ—è¡¨é¡µé¢
+       wx.navigateBack()
    }
  },
   
+   // å›æ˜¾æ”¶è´§åœ°å€çš„é€»è¾‘
+   showAddressInfo(id) {
+     // åˆ¤æ–­æ˜¯å¦å­˜åœ¨ idï¼Œå¦‚æœä¸å­˜åœ¨ idï¼Œreturn ä¸æ‰§è¡Œåç»­çš„é€»è¾‘
+     if (!id) return
+ 
+     // å¦‚æœå­˜åœ¨ idï¼Œå°† id æŒ‚è½½åˆ° this é¡µé¢å®ä¾‹ä¸Š
+     this.addressId = id
+ 
+     // åŠ¨æ€è®¾ç½®å½“å‰é¡µé¢çš„æ ‡é¢˜
+     wx.setNavigationBarTitle({
+       title: 'æ›´æ–°æ”¶è´§åœ°å€'
+     })
+ 
+     // è°ƒç”¨æ–¹æ³•è·å–æ”¶è´§åœ°å€è¯¦ç»†ä¿¡æ¯
+     const { data } = await reqAddressInfo(this.addressId)
+     // å°†è·å–çš„æ•°æ®è¿›è¡Œèµ‹å€¼
+     this.setData(data)
+   },

  onLoad(options) {
    // å¯¹æ ¸å¿ƒç±» QQMapWX è¿›è¡Œå®ä¾‹åŒ–
    this.qqmapwx = new QQMapWX({
      // key è¦ä½¿ç”¨è‡ªå·±ç”³è¯·çš„ key
      // åœ¨è¿›è¡Œé€†è§£æçš„æ—¶å€™ï¼Œå¦‚æœå‘ç° key åªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼Œéœ€è¦åœ¨è…¾è®¯ä½ç½®æœåŠ¡åå°é…ç½®é¢åº¦
      key: 'S5CBZ-TQXCB-L73UJ-J6VJA-FXS53-JNBY3'
    })

+     // å›æ˜¾æ”¶è´§åœ°å€çš„é€»è¾‘
+     this.showAddressInfo(options.id)
  }
    
  // coding...
})
```







### 13. å®ç°åˆ é™¤æ”¶è´§åœ°å€



**æ€è·¯åˆ†æï¼š**



ç‚¹å‡»åˆ é™¤æŒ‰é’®çš„æ—¶å€™ï¼Œéœ€è¦å°†å¯¹åº”çš„åœ°å€è¿›è¡Œåˆ é™¤

å½“ç‚¹å‡»åˆ é™¤æŒ‰é’®çš„æ—¶å€™ï¼Œè°ƒç”¨å°è£…çš„æ¥å£ `API` å‡½æ•° ï¼ŒåŒæ—¶ä¼ é€’éœ€è¦åˆ é™¤çš„æ”¶è´§åœ°å€ `id` å³å¯



**å®ç°æ­¥éª¤ï¼š**



1. ç»™åˆ é™¤æŒ‰é’®ç»‘å®šç‚¹å‡»äº‹ä»¶ `delAddress`ï¼ŒåŒæ—¶é€šè¿‡ `data-id` ä¼ é€’éœ€è¦åˆ é™¤çš„å•†å“ `id`
3. åœ¨ `delAddress` äº‹ä»¶å¤„ç†ç¨‹åºåé¢ï¼Œè°ƒç”¨ `API` å‡½æ•° `reqDelAddress`ï¼Œå¹¶ä¼ é€’ `id`
4. åœ¨åˆ é™¤æ”¶è´§åœ°å€æˆåŠŸä»¥åï¼Œç»™ç”¨æˆ·æç¤º



**è½åœ°ä»£ç ï¼š**



`â¡ï¸ /modules/settingModule/pages/address/list/index.wxml`

```js
<van-icon
+   bindtap="delAddress"
+   data-id="{{ item.id }}" 
  name="delete"
  size="22px"
  color="#999"
/>
```



`â¡ï¸ /modules/settingModule/pages/address/list/index.js`

```js
// åˆ é™¤æ”¶è´§åœ°å€
async delAddress(e) {
  const { id } = e.target.dataset

  await reqDelAddress(id)
  this.getAddressList()
}
```







### ä¼˜åŒ–ï¼šSwipeCell è‡ªåŠ¨æ”¶èµ·åˆ é™¤æ»‘å—



ç›®å‰æˆ‘ä»¬å·²ç»å®ç°äº†æ»‘å—åˆ é™¤æ”¶è´§åœ°å€çš„åŠŸèƒ½ï¼Œ

ä½†æ˜¯æˆ‘ä»¬ä¼šå‘ç°ç‚¹å‡»é¡µé¢ç©ºç™½åŒºåŸŸæˆ–è€…ç‚¹å‡»å…¶ä»–æ”¶è´§åœ°å€æ—¶ï¼Œåˆ é™¤çš„æ»‘å—ä¸ä¼šè‡ªåŠ¨æ”¶èµ·ã€‚



å¦‚æœæƒ³å®ç°ç‚¹å‡»ç©ºç™½åŒºåŸŸè‡ªåŠ¨æ”¶èµ·æ»‘å—åŠŸèƒ½ï¼Œéœ€è¦åœ¨ ç‚¹å‡»ç©ºç™½åŒºåŸŸ ä»¥åŠ å…¶ä»–æ”¶è´§åœ°å€æ—¶ï¼Œè·å–è¦æ”¶èµ·çš„æ»‘å—å®ä¾‹ã€‚

è°ƒç”¨å¯¹åº”æ»‘å—çš„å®ä¾‹æ–¹æ³• `close` å³å¯ã€‚



<img src="http://8.131.91.46:6677/mina/floor/å®ä¾‹å…³æ‰æ»‘å—.png" style="zoom:80%; border: 1px solid #ccc" />





**å®ç°æ€è·¯ï¼š**



1. ç»™æ»‘å—ç»‘å®š id
2. åœ¨æ‰“å¼€æ»‘å—æ—¶ï¼Œè·å–å½“å‰æ»‘å—çš„å®ä¾‹ï¼Œç„¶åå°†å®ä¾‹å­˜å‚¨åˆ° data çš„æ•°ç»„ä¸­ã€‚
3. ç»™é¡µé¢æœ€å¤–å±‚çš„ view åŒæ—¶ç»™æ»‘å—åŒºåŸŸç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œåœ¨äº‹ä»¶å¤„ç†å‡½æ•°ä¸­å¯¹æ•°æ®éå†ï¼Œæ¯ä¸€é¡¹è°ƒç”¨ `close` æ–¹æ³•å…³æ‰æ»‘å—
4. å°†å…³æ‰çš„é€»è¾‘æŠ½å–æˆ behavior æ–‡ä»¶ï¼Œæ–¹ä¾¿åœ¨å…¶ä»–æ–‡ä»¶ä¸­è¿›è¡Œå¤ç”¨ã€‚



**è½åœ°ä»£ç ï¼š**



`â¡ï¸ /behavior/swipeCellBahavior.js`

```js
export const swipeCellBehavior = Behavior({
  data: {
    swipeCelQueue: [] // å®ä¾‹å­˜å‚¨é˜Ÿåˆ—
  },

  methods: {
    // æ‰“å¼€æ»‘å—æ—¶ï¼Œå°†å®ä¾‹å­˜å‚¨åˆ°é˜Ÿåˆ—ä¸­
    onSwipeCellOpen(event) {
      let instance = this.selectComponent(`#${event.target.id}`)
      this.data.swipeCelQueue.push(instance)
    },

    // ç‚¹å‡»å…¶ä»–æ»‘å—æ—¶ï¼Œå…³æ‰å¼€å¯çš„æ»‘å—
    onSwipeCellClick() {
      this.onSwipeCellCommonClick()
    },

    // ç‚¹å‡»é¡µé¢ç©ºç™½åŒºåŸŸæ—¶ï¼Œå…³æ‰å¼€å¯çš„æ»‘å—
    onSwipeCellPageTap() {
      this.onSwipeCellCommonClick()
    },

    // å…³æ‰æ»‘å—çš„ç»Ÿä¸€æ–¹æ³•
    onSwipeCellCommonClick() {
      // å¾ªç¯å…³é—­å¼€å¯çš„æ»‘å—
      this.data.swipeCelQueue.forEach(function (instance) {
        instance.close()
      })
        
      // å°†æ»‘å—è¿›è¡Œæ¸…ç©º
      this.data.swipeCelQueue = []
    }
  }
})

```



`â¡ï¸ /modules/settingModule/pages/address/list/index.wxml`

```html
<view class="container address-list" bindtap="onSwipeCellPageTap">

  <van-swipe-cell
    right-width="{{ 65 }}"
+     data-id="{{ item.id }}"
+     bind:open="onSwipeCellOpen"
+     bind:click="onSwipeCellClick"
  >
  
    <!-- ä»£ç ç•¥... -->
  
  </van-swipe-cell>

</view>
```

