## ç»“ç®—æ”¯ä»˜



### 01. é…ç½®åˆ†åŒ…å¹¶è·³è½¬åˆ°ç»“ç®—é¡µé¢



**æ€è·¯åˆ†æï¼š**



éšç€é¡¹ç›®åŠŸèƒ½çš„å¢åŠ ï¼Œé¡¹ç›®ä½“ç§¯ä¹Ÿéšç€å¢å¤§ï¼Œä»è€Œå½±å“å°ç¨‹åºçš„åŠ è½½é€Ÿåº¦ï¼Œå½±å“ç”¨æˆ·çš„ä½“éªŒã€‚

å› æ­¤æˆ‘ä»¬éœ€è¦å°† `ç»“ç®—æ”¯ä»˜` åŠŸèƒ½é…ç½®æˆä¸€ä¸ªåˆ†åŒ…ï¼Œ

å½“ç”¨æˆ·åœ¨è®¿é—®è®¾ç½®é¡µé¢æ—¶ï¼Œè¿˜é¢„å…ˆåŠ è½½ `ç»“ç®—æ”¯ä»˜` æ‰€åœ¨çš„åˆ†åŒ…



**è½åœ°ä»£ç ï¼š**



`â¡ï¸ app.json`

```json
"subPackages": [
  {
    "root": "modules/settingModule",
    "name": "settingModule",
    "pages": [
      "pages/address/add/index",
      "pages/address/list/index",
      "pages/profile/profile"
    ]
  },
  {
    "root": "modules/goodModule",
    "name": "goodModule",
    "pages": ["pages/goods/list/list", "pages/goods/detail/detail"]
  },
+   {
+     "root": "modules/orderPayModule",
+     "name": "orderPayModule",
+     "pages": [
+       "pages/order/detail/detail",
+       "pages/order/list/list"
+     ]
+   }
],
"preloadRule": {
  "pages/settings/settings": {
    "network": "all",
    "packages": ["settingModule"]
  },
  "pages/category/category": {
    "network": "all",
    "packages": ["goodModule"]
  },
+   "pages/cart/cart": {
+     "network": "all",
+     "packages": ["orderPayModule"]
+   }
}

```



`â¡ï¸ pages/cart/cart.js`

```js
// è·³è½¬åˆ°è®¢å•ç»“ç®—é¡µé¢
toOrder() {
  if (this.data.totalPrice === 0) {
    wx.toast({
      title: 'è¯·é€‰æ‹©éœ€è¦è´­ä¹°çš„å•†å“'
    })

    return
  }

  // è·³è½¬åˆ°è®¢å•çš„ç»“ç®—é¡µé¢
  wx.navigateTo({
    url: '/modules/orderPayModule/pages/order/detail/detail'
  })
}
```



`â¡ï¸ pages/cart/cart.wxml`

```html
<van-submit-bar
  wx:if="{{ cartList.length }}"
  price="{{ totalPrice * 100 }}"
  button-text="å»ç»“ç®—"
  tip="{{ true }}"
+  bindsubmit="toOrder"
>
  <van-checkbox
    value="{{ selectAllStatus }}"
    checked-color="#FA4126"
    bindchange="selectAllStatus"
  >
    å…¨é€‰
  </van-checkbox>
</van-submit-bar>
```







### 02. å°è£…ç»“ç®—æ”¯ä»˜çš„æ¥å£ API



**æ€è·¯åˆ†æï¼š**



ä¸ºäº†æ–¹ä¾¿åç»­è¿›è¡Œç»“ç®—æ”¯ä»˜æ¨¡å—çš„å¼€å‘ï¼Œæˆ‘ä»¬åœ¨è¿™ä¸€èŠ‚å°†ç»“ç®—æ”¯ä»˜æ‰€æœ‰çš„æ¥å£å°è£…æˆæ¥å£ API å‡½æ•°



**è½åœ°ä»£ç ï¼š**



`â¡ï¸ /api/orderpay.js`

```js
import http from '@/utils/http'

/**
 * @description è·å–è®¢å•è¯¦æƒ…
 * @returns Promise
 */
export const reqOrderInfo = () => {
  return http.get('/order/trade')
}

/**
 * @description è·å–è®¢å•åˆ—è¡¨
 * @param {*} page é¡µç 
 * @param {*} limit æ¯é¡µå±•ç¤ºçš„æ¡æ•°
 * @returns Promise
 */
export const reqOrderList = (page, limit) => {
  return http.get(`/order/order/${page}/${limit}`)
}

/**
 * @description è·å–è®¢å•æ”¶è´§åœ°å€
 * @returns Promise
 */
export const reqOrderAddress = () => {
  return http.get('/userAddress/getOrderAddress')
}

/**
 * @description è·å–ç«‹å³è´­ä¹°å•†å“çš„è¯¦æƒ…ä¿¡æ¯
 * @param { Object } params { goodsId: å•†å“ Id,  blessingï¼šç¥ç¦è¯­ }
 * @returns Promise
 */
export const reqBuyNowGoods = ({ goodsId, ...data }) => {
  return http.get(`/order/buy/${goodsId}`, data)
}

/**
 * @description æäº¤è®¢å•
 * @returns Promise
 */
export const reqSubmitOrder = () => {
  return http.post('/order/submitOrder')
}

/**
 * @description è·å–å¾®ä¿¡é¢„æ”¯ä»˜ä¿¡æ¯
 * @param {*} orderNo è®¢å• ID
 * @returns Promise
 */
export const reqPreBuyInfo = (orderNo) => {
  return http.get(`/webChat/createJsapi/${orderNo}`)
}

/**
 * @description å¾®ä¿¡æ”¯ä»˜çŠ¶æ€æŸ¥è¯¢
 * @param {*} orderNo
 * @returns Promise
 */
export const reqPayStatus = (orderNo) => {
  return http.get(`/webChat/queryPayStatus/${orderNo}`)
}

```











### 03. å•†å“ç»“ç®—-è·å–æ”¶è´§åœ°å€



**æ€è·¯åˆ†æï¼š**



è¿›å…¥ç»“ç®—æ”¯ä»˜é¡µé¢åï¼Œéœ€è¦è·å–æ”¶è´§åœ°å€ä¿¡æ¯ï¼Œåœ¨è·å–åˆ°æ”¶è´§åœ°å€ä»¥åï¼Œéœ€è¦è¿›è¡Œåˆ¤æ–­ï¼Œ

å¦‚æœæ²¡æœ‰è·å–åˆ°æ”¶è´§åœ°å€ï¼Œéœ€è¦å±•ç¤ºæ·»åŠ æ”¶è´§åœ°å€çš„ç»“æ„ï¼Œ

å¦‚æœè·å–åˆ°äº†æ”¶è´§åœ°å€ï¼Œéœ€è¦æ¸²æŸ“æ”¶è´§åœ°å€ã€‚



**å®ç°æ­¥éª¤ï¼š**



1. åœ¨è¿›å…¥ç»“ç®—é¡µé¢çš„æ—¶å€™ï¼Œè°ƒç”¨æ¥å£ `API` å‡½æ•°ï¼Œè·å–æ•°æ®
2. ç„¶åæ ¹æ®æ•°æ®å¹¶æ¸²æŸ“ç»“æ„



**è½åœ°ä»£ç ï¼š**



`â¡ï¸ /pages/order/detail/index.js`

```js
import { getTradeAddress } from '../../../api/order'

Page({
    
  data: {
    // coding...
+     orderAddress: {} // æ”¶è´§åœ°å€
  },

+   // è·å–æ”¶è´§åœ°å€
+   async getAddress() {
+     const { data: orderAddress } = await reqOrderAddress()
+ 
+     this.setData({
+       orderAddress
+     })
+   },

+   // é¡µé¢å±•ç¤ºæ—¶è§¦å‘çš„é’©å­å‡½æ•°
+   onShow() {
+     this.getAddress()
+   }
})
```



`â¡ï¸ /pages/order/detail/index.wxml`

```html
<!--pages/order/index.wxml-->
<view class="container order">
  <view class="address-card">
    <!-- æ·»åŠ æ”¶è´§åœ°å€ -->
    <view wx:if="{{ !tradeAddress.id }}" class="add-address"  bindtap="toAddress">
      <van-icon size="22px" name="add" />
      <view>æ·»åŠ æ”¶è´§åœ°å€</view>
    </view>

    <view wx:else class="order-address flex">
      <view class="address-content">
        <view class="title">{{ tradeAddress.fullAddress }}</view>
        <view class="info flex">
          <text>{{ tradeAddress.name }}</text>
          <text>{{ tradeAddress.phone }}</text>
        </view>
      </view>

      <view class="select-address">
        <navigator class="navigator" url="/modules/settingModule/pages/address/list/index">
          <van-icon color="#bbb" name="arrow" size="22px" />
        </navigator>
      </view>
    </view>

    <view class="top-line"></view>
  </view>

  <view class="order-info">
    <!-- coding... -->
  </view>

</view>
```







### 04. å•†å“ç»“ç®—-æ›´æ–°æ”¶è´§åœ°å€åŠŸèƒ½



**æ€è·¯åˆ†æï¼š**



å½“ç”¨æˆ·éœ€è¦æ›´æ”¹æ”¶è´§åœ°å€æ—¶ï¼Œæˆ‘ä»¬éœ€è¦è·³è½¬åˆ°æ”¶è´§åœ°å€é¡µé¢ï¼Œé‡æ–°é€‰æ‹©æ”¶è´§åœ°å€

å½“ç”¨æˆ·ç‚¹å‡»äº†æŸä¸ªåœ°å€ä»¥åï¼Œæˆ‘ä»¬éœ€è¦å°†è¯¥åœ°å€æ˜¾ç¤ºåˆ°å•†å“ç»“ç®—é¡µé¢ä¸­ã€‚



æ›´æ–°æ”¶è´§åœ°å€åŠŸèƒ½ï¼Œé‡‡ç”¨ `getApp()` å…¨å±€å…±äº«æ•°æ®çš„æ–¹å¼æ¥å®ç°ã€‚



**å®ç°æ­¥éª¤ï¼š**



4. åœ¨ `app.js` ä¸­å®šä¹‰å…¨å±€å…±äº«çš„æ•°æ® `globalData.address`
2. ç‚¹å‡»ç®­å¤´ï¼Œæºå¸¦å‚æ•°è·³è½¬åˆ°æ”¶è´§åœ°å€é¡µé¢ï¼Œæ ‡è¯†æ˜¯ä»è®¢å•ç»“ç®—é¡µé¢è¿›å…¥
3. åœ¨é€‰æ‹©æ”¶è´§åœ°å€æˆåŠŸä»¥åï¼Œå°†æ•°æ®å­˜å‚¨åˆ° `globalData.address`ä¸­ï¼Œç„¶åè¿”å›åˆ°è®¢å•ç»“ç®—é¡µé¢ã€‚
4. åœ¨è®¢å•ç»“ç®—é¡µé¢åˆ¤æ–­ `globalData.address` æ˜¯å¦å­˜åœ¨æ”¶è´§åœ°å€æ•°æ®ï¼Œå¦‚æœå­˜åœ¨åˆ™æ¸²æŸ“



**è½åœ°ä»£ç ï¼š**



`â¡ï¸ app.js`

```js
App({
    
+   // å®šä¹‰å…¨å±€å…±äº«çš„æ•°æ®
+   globalData: {
+    address: {}
+  }
    
  // coding...
})
```





`â¡ï¸ /pages/address/list/index.html`

```html
<!-- æ¯ä¸€ä¸ªæ”¶è´§åœ°å€ -->

<view
  class="info"
+   bindtap="changeAddress"
+   data-id="{{ item.id }}"
>
  <view class="user-info">
    <text>{{ item.name }}</text>
    <text>{{ item.phone }}</text>
    <text wx:if="{{ item.isDefault === 1 }}" class="default-tag">é»˜è®¤</text>
  </view>

  <view class="address-info"> {{ item.fullAddress }} </view>
</view>
```



`â¡ï¸ /pages/address/list/index.js`

```js
// å¯¼å…¥æ¥å£ API å‡½æ•°
import { reqAddressList, reqDelAddress } from '@/api/address'
import { swipeCellBehavior } from '@/behaviors/swipeCell'

+ // è·å–å…¨å±€çš„åº”ç”¨å®ä¾‹
+ const app = getApp()

Page({

  // coding...

+   // åˆ‡æ¢æ”¶è´§åœ°å€
+   changeAddress(event) {
+     // åˆ¤æ–­æ˜¯å¦æ˜¯ä»è®¢å•ç»“ç®—é¡µé¢è¿›å…¥
+     if (this.flag !== '1') return
+ 
+     // è·å–åˆ°ç‚¹å‡»çš„æ”¶è´§åœ°å€ id
+     const addressId = event.currentTarget.dataset.id
+     // ä»æ”¶è´§åœ°å€åˆ—è¡¨ä¸­è·å–åˆ°è·å–åˆ°ç‚¹å‡»çš„æ”¶è´§åœ°å€è¯¦ç»†ä¿¡æ¯
+     const address = this.data.addressList.find((item) => item.id === addressId)
+ 
+     // å¦‚æœè·å–æˆåŠŸï¼Œå°†æ•°æ®å­˜å‚¨åˆ° globalData ä¸­
+     if (address) {
+       app.globalData.address = address
+       wx.navigateBack()
+     }
+   },

+   onLoad(options) {
+     this.flag = options.flag
+   }
})

```



`â¡ï¸ /pages/order/detail/index.wxml`

```html
<view class="select-address">
  <navigator
    class="navigator"
+     url="/modules/settingModule/pages/address/list/index?flag=1"
  >
    <van-icon color="#bbb" name="arrow" size="22px" />
  </navigator>
</view>
```



`â¡ï¸ /pages/order/detail/index.js`

```js
  // è·å–è®¢å•é¡µé¢çš„æ”¶è´§åœ°å€
  async getAddress() {
      
+     // å¦‚æœ globalData å­˜åœ¨æ”¶è´§åœ°å€ï¼Œå–å‡ºæ”¶è´§åœ°å€
+     if (app.globalData.address.id) {
+       this.setData({
+         orderAddress: app.globalData.address
+       })
+ 
+       // åœ¨èµ‹å€¼ä»¥åéœ€è¦å°†æ”¶è´§åœ°å€æ¸…ç©º
+       app.globalData.address = {}
+ 
+       return
+     }

    // å¦‚æœ globalData ä¸­ä¸å­˜åœ¨æ”¶è´§åœ°å€ï¼Œè·å–æ”¶è´§åœ°å€æ¸²æŸ“å³å¯
    const { data: orderAddress } = await reqOrderAddress()

    this.setData({
      orderAddress
    })
  },
```













### 05. å•†å“ç»“ç®—-è·å–è®¢å•è¯¦æƒ…æ•°æ®



**æ€è·¯åˆ†æï¼š**



å•†å“ç»“ç®—é¡µé¢æ•°æ®è·å–æ”¶è´§åœ°å€ä»¥åŠå•†å“è®¢å•ä¿¡æ¯



**å®ç°æ­¥éª¤ï¼š**



2. å¯¼å…¥å°è£…çš„æ¥å£ `API` å‡½æ•°
4. åœ¨è¿›å…¥ç»“ç®—é¡µé¢çš„æ—¶å€™ï¼Œè°ƒç”¨æ¥å£ `API` å‡½æ•°ï¼Œè·å–æ•°æ®ï¼Œç„¶åæ ¹æ®æ•°æ®å¹¶æ¸²æŸ“ç»“æ„å³å¯



**è½åœ°ä»£ç ï¼š**



`â¡ï¸ /pages/order/detail/index.js`

```js
+ import { reqOrderAddress, reqOrderInfo } from '@/api/orderpay'

Page({
    
  data: {
    // coding...
    orderAddress: {}, // æ”¶è´§åœ°å€
+     orderInfo: {}, // è®¢å•å•†å“è¯¦æƒ…
  },
     
+   // è·å–è®¢å•è¯¦æƒ…
+   async getOrderInfo() {
+     const { data: orderInfo } = await reqOrderInfo()
+ 
+     // åˆ¤æ–­æ˜¯å¦å­˜åœ¨ç¥ç¦è¯­
+     // å¦‚æœéœ€è¦è´­ä¹°å¤šä¸ªå•†å“ï¼ŒæŒ‘é€‰ç¬¬ä¸€ä¸ªå¡«å†™äº†ç¥ç¦è¯­çš„å•†å“è¿›è¡Œèµ‹å€¼
+     const orderGoods = orderInfo.cartVoList.find((item) => item.blessing !== '')
+ 
+     this.setData({
+       orderInfo,
+       blessing: orderGoods && orderGoods.blessing
+     })
+   },

  // åœ¨é¡µé¢å±•ç¤ºçš„æ—¶å€™è¿›è¡Œè§¦å‘
  onShow() {
    // è·å–æ”¶è´§åœ°å€
    this.getAddress()

+     // è·å–è®¢å•ç»“ç®—é¡µé¢çš„å•†å“ä¿¡æ¯
+     this.getOrderInfo()
  },
})
```



`â¡ï¸ /pages/order/detail/index.wxml`

```html
<!--pages/order/index.wxml-->
<view class="container order">
  <view class="address-card">
    <!-- æ·»åŠ æ”¶è´§åœ°å€ -->
    <!-- coding... -->
  </view>

  <view class="goods-wraper">
    <!-- å•†å“æ¸…å• -->
    <view class="goods-list">

+       <view class="goods-item flex" wx:for="{{ tradeInfo.cartVoList }}" wx:key="goodsId">
        <view class="img">
+           <image src="{{ item.imageUrl }}" />
        </view>
        <view class="content">
+           <view class="goods-title">{{ item.name }}</view>
          <view class="goods-price">
+             <view class="price"> Â¥ {{ item.price }}</view>
+             <view>x {{ item.count }}</view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <view class="payment">
    <!-- æ”¯ä»˜æ–¹å¼ -->
    <view class="time-wraper flex">
      <image src="/static/images/payment_wxzf.png" />
      <view class="title">æ”¯ä»˜æ–¹å¼</view>
      <van-checkbox value="{{true}}"></van-checkbox>
    </view>
  </view>

  <!-- æ”¯ä»˜åŒºåŸŸ -->
  <view class="footer flex">
+     <view class="left"> Â¥ {{ tradeInfo.totalAmount }} </view>
    <viwe class="right">ç»“ç®—</viwe>
  </view>

  <!-- æ—¥æœŸé€‰æ‹©å¼¹æ¡† -->
  <van-popup show="{{ show }}" round position="bottom" custom-style="height: 50%" bind:close="onClose">
    <van-datetime-picker type="date" min-date="{{ minDate }}" model:value="{{ currentDate }}" bind:confirm="onConfirmTimerPicker" bind:cancel="onCancelTimePicker" />
  </van-popup>

</view>
```







### 06. å•†å“ç»“ç®—-è·å–ç«‹å³è´­ä¹°æ•°æ®



**æ€è·¯åˆ†æï¼š**



å½“ç”¨æˆ·ä»å•†å“è¯¦æƒ…ç‚¹å‡»ç«‹å³è´­ä¹°è¿›å…¥å•†å“ç»“ç®—é¡µé¢çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å•†å“ç»“ç®—é¡µé¢å±•ç¤ºç«‹å³è´­ä¹°å•†å“çš„åŸºæœ¬ä¿¡æ¯ã€‚



åœ¨è·³è½¬åˆ°å•†å“ç»“ç®—é¡µé¢çš„æ—¶å€™ï¼Œæˆ‘ä»¬å·²ç»æºå¸¦äº†å•†å“çš„ `id` å’Œ `ç¥ç¦è¯­`ã€‚

åœ¨ç»“ç®—é¡µé¢ï¼Œåªéœ€è¦è·å–åˆ°ä¼ é€’çš„å‚æ•°ï¼Œç„¶åæ ¹æ®ä¼ é€’çš„å‚æ•°è°ƒç”¨æ¥å£å³å¯ã€‚



**å®ç°æ­¥éª¤ï¼š**



2. åœ¨é¡µé¢æ‰“å¼€çš„æ—¶å€™ï¼Œ`onShow` ä¸­æ¥å—ä¼ é€’çš„å‚æ•°ï¼Œå¹¶èµ‹å€¼ç»™ `data` ä¸­çš„çŠ¶æ€
3. åœ¨ `getOrderInfo` å‡½æ•°ä¸­ï¼Œåˆ¤æ–­ç«‹å³è´­ä¹°å•†å“çš„ `id` æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨è°ƒç”¨ç«‹å³è´­ä¹°çš„æ¥å£
4. è·å–æ•°æ®åï¼Œç„¶åæ ¹æ®æ•°æ®å¹¶æ¸²æŸ“ç»“æ„å³å¯



**è½åœ°ä»£ç ï¼š**



`â¡ï¸ /pages/order/detail/index.js`

```js
import {
  reqOrderAddress,
  reqOrderInfo,
+   reqBuyNowGoods
} from '@/api/orderpay'

Page({

    
  // è·å–è®¢å•è¯¦æƒ…
  async getOrderInfo() {
+ 	  // ä» data ä¸­ç»“æ„æ•°æ®      
+     const { goodsId, blessing } = this.data

+	 // åˆ¤æ–­æ˜¯å¦å­˜åœ¨å•†å“ idï¼Œ
     // å¦‚æœå­˜åœ¨è°ƒç”¨ç«‹å³è´­ä¹°å•†å“è¯¦æƒ…çš„æ¥å£
     // ä¸å­˜åœ¨è°ƒç”¨è·å–è®¢å•è¯¦æƒ…æ•°æ®æ¥å£
+    const { data: orderInfo } = goodsId
      ? await reqBuyNowGoods({ goodsId, blessing })
      : await reqOrderInfo()

    // åˆ¤æ–­æ˜¯å¦å­˜åœ¨ç¥ç¦è¯­
    // å¦‚æœéœ€è¦è´­ä¹°å¤šä¸ªå•†å“ï¼ŒæŒ‘é€‰ç¬¬ä¸€ä¸ªå¡«å†™äº†ç¥ç¦è¯­çš„å•†å“è¿›è¡Œèµ‹å€¼
    const orderGoods = orderInfo.cartVoList.find((item) => item.blessing !== '')
      
    this.setData({
      orderInfo,
      orderGoods && orderGoods.blessing
    })
  }
    
 +  // æ¥æ”¶ç«‹å³è´­ä¹°ä¼ é€’çš„å‚æ•°
 +  onLoad (options) {
 +    this.setData({
 +       ...options
 +    })
 +  },

  // åœ¨é¡µé¢å±•ç¤ºçš„æ—¶å€™è¿›è¡Œè§¦å‘
  onShow() {
    // è·å–æ”¶è´§åœ°å€
    this.getAddress()

    // è·å–è®¢å•ç»“ç®—é¡µé¢çš„å•†å“ä¿¡æ¯
    this.getOrderInfo()
  }
})

```









### 07. å•†å“ç»“ç®—-æ”¶é›†é€è¾¾æ—¶é—´



**æ€è·¯åˆ†æï¼š**



å½“é€‰æ‹©é€è¾¾æ—¥æœŸçš„æ—¶å€™ï¼Œéœ€è¦é€‰æ‹©æ”¶è´§çš„æ—¶é—´ï¼Œæˆ‘ä»¬å¸Œæœ›è·å–åˆ°çš„æ”¶è´§çš„æ—¶é—´æ ¼å¼æ˜¯ï¼šå¹´æœˆæ—¥

ä½†æ˜¯æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯å°ç¨‹åºæä¾›çš„ `vant` ç»„ä»¶ï¼Œç»„ä»¶è¿”å›çš„æ—¶å€™å¹¶ä¸æ˜¯çœŸæ­£çš„æ—¶åˆ†ç§’ï¼Œè€Œæ˜¯æ—¶é—´æˆ³



è¿™æ—¶å€™å¯ä»¥è°ƒç”¨å°ç¨‹åºé¡¹ç›®åˆå§‹åŒ–æ—¶ï¼Œå°ç¨‹åºå°è£…çš„æ—¶é—´æ ¼å¼åŒ–å·¥å…·



**å®ç°æ­¥éª¤ï¼š**



1. åœ¨å•†å“ç»“ç®—é¡µé¢å¯¼å…¥å°è£…å¥½çš„æ ¼å¼åŒ–æ—¶é—´çš„æ–¹æ³• `formatTime`
2. è°ƒç”¨  `formatTime` ï¼Œä¼ å…¥éœ€è¦æ ¼å¼åŒ–çš„æ—¶é—´æˆ³



**è½åœ°ä»£ç ï¼š**



`â¡ï¸ /pages/order/detail/index.js`

```js
import { formatTime } from '../../../utils/formatTime.js'

Page({
  
  // coding...

  // æœŸæœ›é€è¾¾æ—¥æœŸç¡®å®šæŒ‰é’®
  onConfirmTimerPicker(event) {
    // ä½¿ç”¨ new Date å°†æ—¶é—´æˆ³è½¬æ¢æˆ JS ä¸­çš„æ—¥æœŸå¯¹è±¡
    const time = formatTime(new Date(event.detail))
    
    // å°†è½¬æ¢ä»¥åçš„æ—¶é—´èµ‹å€¼ç»™é€åˆ°æ—¶é—´
    this.setData({
      show: false,
      deliveryDate: time
    })
  }
 
  // coding...
}
```









### 08. å•†å“ç»“ç®—-è¡¨å•æ•°æ®éªŒè¯



**æ€è·¯åˆ†æï¼š**



ä½¿ç”¨ `async-validator` å¯¹ä»£ç è¿›è¡ŒéªŒè¯



1. æ”¶è´§åœ°å€ä¸èƒ½ä¸ºç©º
2. è®¢è´­äººå§“åä¸èƒ½ä¸ºç©ºï¼Œä¸”ä¸èƒ½è¾“å…¥ç‰¹æ®Šå­—ç¬¦
3. è®¢è´­äººæ‰‹æœºå·ä¸èƒ½ä¸ºç©ºï¼Œä¸”è¾“å…¥çš„æ‰‹æœºå·å¿…é¡»åˆæ³•
4. é€è¾¾æ—¥æœŸä¸èƒ½ä¸ºç©º



**è½åœ°ä»£ç ï¼š**



```js
import { reqOrderAddress, reqOrderInfo, reqBuyNowGoods } from '@/api/orderpay'
// å¯¼å…¥ async-validator å¯¹å‚æ•°è¿›è¡ŒéªŒè¯
import Schema from 'async-validator'
// å¯¼å…¥æ ¼å¼åŒ–æ—¶é—´çš„æ–¹æ³•
import { formatTime } from '@/utils/formatTime'

// è·å–åº”ç”¨å®ä¾‹
const app = getApp()

Page({
  data: {
    buyName: '', // è®¢è´­äººå§“å
    buyPhone: '', // è®¢è´­äººæ‰‹æœºå·
    deliveryDate: '', // æœŸæœ›é€è¾¾æ—¥æœŸ
    blessing: '', // ç¥ç¦è¯­
    show: false, // æœŸæœ›é€è¾¾æ—¥æœŸå¼¹æ¡†
    orderAddress: {}, // æ”¶è´§åœ°å€
    orderInfo: {}, // è®¢å•å•†å“è¯¦æƒ…
    minDate: new Date().getTime(),
    currentDate: new Date().getTime()
  },

  async submitOrder() {
    // ä» data ä¸­ç»“æ„æ•°æ®
    const {
      buyName,
      buyPhone,
      deliveryDate,
      blessing,
      orderInfo,
      orderAddress
    } = this.data

    // ç»„ç»‡è¯·æ±‚å‚æ•°
    const params = {
      buyName,
      buyPhone,
      deliveryDate,
      remarks: blessing,
      cartList: orderInfo.cartVoList,
      userAddressId: orderAddress.id
    }

    // å¯¹è¯·æ±‚å‚æ•°è¿›é¡¹éªŒè¯
    const { valid } = await this.validatorPerson(params)

    // æ‰“å°éªŒè¯ç»“æœ
    console.log(valid)
  },

  // å¯¹æ–°å¢æ”¶è´§åœ°å€è¯·æ±‚å‚æ•°è¿›è¡ŒéªŒè¯
  validatorPerson(params) {
    // éªŒè¯æ”¶è´§äººï¼Œæ˜¯å¦åªåŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œä¸­æ–‡å­—ç¬¦
    const nameRegExp = '^[a-zA-Z\\d\\u4e00-\\u9fa5]+$'

    // éªŒè¯æ‰‹æœºå·ï¼Œæ˜¯å¦ç¬¦åˆä¸­å›½å¤§é™†æ‰‹æœºå·ç çš„æ ¼å¼
    const phoneReg = '^1(?:3\\d|4[4-9]|5[0-35-9]|6[67]|7[0-8]|8\\d|9\\d)\\d{8}$'

    // åˆ›å»ºéªŒè¯è§„åˆ™
    const rules = {
      userAddressId: [{ required: true, message: 'è¯·é€‰æ‹©æ”¶è´§åœ°å€' }],
      buyName: [
        { required: true, message: 'è¯·è¾“å…¥æ”¶è´§äººå§“å' },
        { pattern: nameRegExp, message: 'æ”¶è´§äººå§“åä¸åˆæ³•' }
      ],
      buyPhone: [
        { required: true, message: 'è¯·è¾“å…¥æ”¶è´§äººæ‰‹æœºå·' },
        { pattern: phoneReg, message: 'æ”¶è´§äººæ‰‹æœºå·ä¸åˆæ³•' }
      ],
      deliveryDate: { required: true, message: 'è¯·é€‰æ‹©é€è¾¾æ—¶é—´' }
    }

    // ä¼ å…¥éªŒè¯è§„åˆ™è¿›è¡Œå®ä¾‹åŒ–
    const validator = new Schema(rules)

    // è°ƒç”¨å®ä¾‹æ–¹æ³•å¯¹è¯·æ±‚å‚æ•°è¿›è¡ŒéªŒè¯
    // æ³¨æ„ï¼šæˆ‘ä»¬å¸Œæœ›å°†éªŒè¯ç»“æœé€šè¿‡ Promise çš„å½¢å¼è¿”å›ç»™å‡½æ•°çš„è°ƒç”¨è€…
    return new Promise((resolve) => {
      validator.validate(params, (errors) => {
        if (errors) {
          // å¦‚æœéªŒè¯å¤±è´¥ï¼Œéœ€è¦ç»™ç”¨æˆ·è¿›è¡Œæç¤º
          wx.toast({ title: errors[0].message })
          // å¦‚æœå±æ€§å€¼æ˜¯ falseï¼Œè¯´æ˜éªŒè¯å¤±è´¥
          resolve({ valid: false })
        } else {
          // å¦‚æœå±æ€§å€¼æ˜¯ trueï¼Œè¯´æ˜éªŒè¯æˆåŠŸ
          resolve({ valid: true })
        }
      })
    })
  },
    
  
  // coding....
})
```





### 09. å°ç¨‹åºæ”¯ä»˜-å°ç¨‹åºæ”¯ä»˜æµç¨‹



**å°ç¨‹åºæ”¯ä»˜å›¾ç¤ºï¼š**



<img src="http://8.131.91.46:6677/mina/floor/å°ç¨‹åºæ”¯ä»˜æµç¨‹.png" style="zoom:80%; border:1px solid #ccc" />





**å‰ç«¯éœ€è¦åšçš„äº‹æƒ…ï¼š**



1. `ç”Ÿæˆå¹³å°è®¢å•`ï¼šå‰ç«¯è°ƒç”¨æ¥å£ï¼Œå‘åç«¯ä¼ é€’éœ€è¦è´­ä¹°çš„å•†å“ä¿¡æ¯ã€æ”¶è´§äººä¿¡æ¯ï¼Œ[åç«¯ç”Ÿæˆå¹³å°è®¢å•ï¼Œè¿”å›è®¢å•ç¼–å·]

2. `è·å–é¢„ä»˜å•ä¿¡æ¯`ï¼šå°†è®¢å•ç¼–å·å‘é€ç»™åç«¯åï¼Œ [åç«¯å‘å¾®ä¿¡æœåŠ¡å™¨è·å–é¢„ä»˜å•ä¿¡æ¯ï¼Œåç«¯ä¼šå°†å¾®ä¿¡æœåŠ¡å™¨è¿”å›çš„é¢„ä»˜å•ä¿¡æ¯è¿›è¡ŒåŠ å¯†ï¼Œç„¶åå°†åŠ å¯†ä»¥åçš„é¢„ä»˜å•ä¿¡æ¯è¿”å›ç»™å‰ç«¯]

3. `å‘èµ·å¾®ä¿¡æ”¯ä»˜`ï¼šå‰ç«¯è°ƒç”¨ wx.requestPayment() å‘èµ·å¾®ä¿¡æ”¯ä»˜

4. `æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€`ï¼šè°ƒç”¨æ¥å£æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€











### 10. å°ç¨‹åºæ”¯ä»˜-åˆ›å»ºå¹³å°è®¢å•



**æ€è·¯åˆ†æï¼š**



ç”¨æˆ·åœ¨å®Œæˆé€‰è´­æµç¨‹ï¼Œç¡®è®¤å•†å“ä¿¡æ¯ã€è®¢è´­äººã€æ”¶è´§äººç­‰ä¿¡æ¯æ— è¯¯åï¼Œ

ç”¨æˆ·éœ€è¦ç‚¹å‡»æäº¤è®¢å•æŒ‰é’®ï¼Œå¼€å§‹è¿›è¡Œä¸‹å•æ”¯ä»˜ï¼Œè¿™æ—¶å€™éœ€è¦å…ˆåˆ›å»ºå¹³å°è®¢å•ã€‚



**å®ç°æ­¥éª¤ï¼š**



1. åœ¨æäº¤è®¢å•çš„äº‹ä»¶å¤„ç†å‡½æ•°ä¸­è°ƒç”¨å°è£…çš„æ¥å£ API å‡½æ•°
2. åœ¨æ¥å£è°ƒç”¨æˆåŠŸä»¥åï¼Œå°†æœåŠ¡å™¨å“åº”çš„è®¢å•ç¼–ç æŒ‚è½½åˆ°é¡µé¢å®ä¾‹ä¸Šã€‚



**è½åœ°ä»£ç ï¼š**



`â¡ï¸ /pages/order/detail/index.js`

```js
import {
  reqOrderAddress,
  reqOrderInfo,
  reqBuyNowGoods,
+   reqSubmitOrder
} from '@/api/orderpay'

Page({
   
  // coding...
    
  // æäº¤è®¢å•
    // å¤„ç†æäº¤è®¢å•
  async submitOrder() {
    // éœ€è¦ä» data ä¸­è§£æ„æ•°æ®
    const {
      buyName,
      buyPhone,
      deliveryDate,
      blessing,
      orderAddress,
      orderInfo
    } = this.data

    // éœ€è¦æ ¹æ®æ¥å£è¦æ±‚ç»„ç»‡è¯·æ±‚å‚æ•°
    const params = {
      buyName,
      buyPhone,
      cartList: orderInfo.cartVoList,
      deliveryDate,
      remarks: blessing,
      userAddressId: orderAddress.id
    }

    // å¯¹è¯·æ±‚å‚æ•°è¿›è¡ŒéªŒè¯
    const { valid } = await this.validatorPerson(params)

+     // å¦‚æœéªŒè¯å¤±è´¥ï¼Œç›´æ¥ returnï¼Œä¸æ‰§è¡Œåç»­çš„é€»è¾‘å¤„ç†
+     if (!valid) return
+ 
+     // è°ƒç”¨æ¥å£ï¼Œåˆ›å»ºå¹³å°è®¢å•
+     const res = await reqSubmitOrder(params)
+ 
+     // åœ¨å¹³å°è®¢å•åˆ›å»ºæˆåŠŸä»¥åï¼Œå°†è®¢å•ç¼–å·æŒ‚è½½åˆ°é¡µé¢å®ä¾‹ä¸Š
+     if (res.code === 200) {
+       // å°†è®¢å•ç¼–å·æŒ‚è½½åˆ°é¡µé¢å®ä¾‹ä¸Š
+       this.orderNo = res.data
+     }
  }
    
    
  // coding...
})
```







### 11. å°ç¨‹åºæ”¯ä»˜-è·å–é¢„ä»˜å•ä¿¡æ¯



**æ€è·¯åˆ†æï¼š**



å°†è®¢å•ç¼–å·å‘é€ç»™å…¬å¸çš„åç«¯ï¼Œå…¬å¸çš„åç«¯ä¼šä»æ•°æ®åº“æ‰¾åˆ°å¯¹åº”è®¢å•çš„ä¿¡æ¯ã€‚

ç„¶åè°ƒç”¨å¾®ä¿¡æœåŠ¡å™¨çš„ ä¸‹å•æ¥å£ è¿›è¡Œåˆ›å»ºè®¢å•ï¼Œè®¢å•åˆ›å»ºæˆåŠŸä»¥åï¼Œå¾®ä¿¡æœåŠ¡å™¨ä¼šç»™å…¬å¸åç«¯è¿”å›é¢„ä»˜å•ä¿¡æ¯ã€‚

å…¬å¸åç«¯å¯¹è¿”å›çš„é¢„ä»˜å•ä¿¡æ¯è¿›è¡ŒåŠ å¯†ï¼Œè¿”å›ç»™å°ç¨‹åºå®¢æˆ·ç«¯ã€‚



è¿™ä¸€æ­¥ï¼Œå’±ä»¬éœ€è¦åšçš„å°±æ˜¯ï¼šè®¢å•ç¼–å·å‘é€ç»™å…¬å¸çš„åç«¯ï¼Œå…¶ä»–é€»è¾‘æ—¶åç«¯æ¥å®Œæˆçš„ã€‚



> ğŸ“Œï¼šæ³¨æ„äº‹é¡¹ï¼š
>
> â€‹	å°ç¨‹åºæ”¯ä»˜åé¢çš„ä»£ç ï¼Œå¤§ä¼™åœ¨å®ç°çš„æ—¶å€™ï¼Œä¼šå‡ºç°å¼‚å¸¸ã€‚
>
> â€‹	è¿™æ˜¯å› ä¸ºæ²¡æœ‰å°ç¨‹åºçš„å¼€å‘æƒé™ï¼Œä»¥ååœ¨å®é™…å¼€å‘ä¸­ï¼Œåªéœ€è¦å‚è€ƒå½“å‰æµç¨‹è¿›è¡Œå¼€å‘å³å¯



**è½åœ°ä»£ç ï¼š**



`â¡ï¸ /pages/order/detail/index.js`

```js
Page({
    // å¤„ç†æäº¤è®¢å•
  async submitOrder() {
    // éœ€è¦ä» data ä¸­è§£æ„æ•°æ®
    const {
      buyName,
      buyPhone,
      deliveryDate,
      blessing,
      orderAddress,
      orderInfo
    } = this.data

    // éœ€è¦æ ¹æ®æ¥å£è¦æ±‚ç»„ç»‡è¯·æ±‚å‚æ•°
    const params = {
      buyName,
      buyPhone,
      cartList: orderInfo.cartVoList,
      deliveryDate,
      remarks: blessing,
      userAddressId: orderAddress.id
    }

    // å¯¹è¯·æ±‚å‚æ•°è¿›è¡ŒéªŒè¯
    const { valid } = await this.validatorPerson(params)

    // å¦‚æœè¯·æ±‚å‚æ•°éªŒè¯å¤±è´¥ï¼Œç›´æ¥ return ï¼Œä¸æ‰§è¡Œåç»­çš„é€»è¾‘
    if (!valid) return

    // è°ƒç”¨æ¥å£ï¼Œåˆ›å»ºå¹³å°è®¢å•
    const res = await reqSubmitOrder(params)

    if (res.code === 200) {
      // åœ¨å¹³å°è®¢å•åˆ›å»ºæˆåŠŸä»¥åï¼Œéœ€è¦å°†æœåŠ¡å™¨ã€åç«¯è¿”å›çš„è®¢å•ç¼–å·æŒ‚è½½åˆ°é¡µé¢å®ä¾‹ä¸Š
      this.orderNo = res.data
      
+       // è·å–é¢„ä»˜å•ä¿¡æ¯ã€æ”¯ä»˜å‚æ•°
+       this.advancePay()
    }
  },

+   // è·å–é¢„ä»˜å•ä¿¡æ¯ã€æ”¯ä»˜å‚æ•°
+   async advancePay() {
+     // è°ƒç”¨æ¥å£ï¼Œè·å–é¢„ä»˜å•ä¿¡æ¯ã€æ”¯ä»˜å‚æ•°
+     const payParams = await reqPrePayInfo(this.orderNo)
+ 
+     if (payParams.code === 200) {
+       console.log(res.data)
+     }
+   },

})
```







### 12. å°ç¨‹åºæ”¯ä»˜-å‘èµ·å¾®ä¿¡æ”¯ä»˜



**çŸ¥è¯†ç‚¹ï¼š**



å°ç¨‹åºå®¢æˆ·ç«¯åœ¨æ¥æ”¶æ”¯ä»˜å‚æ•°åï¼Œè°ƒç”¨ `wx.requestPayment()` å‘èµ·å¾®ä¿¡æ”¯ä»˜ï¼Œ

å”¤é†’æ”¯ä»˜å¼¹çª—ï¼Œç”¨æˆ·å¼€è¾“å…¥æ”¯ä»˜å¯†ç æˆ–è€…è¿›è¡ŒæŒ‡çº¹ç­‰æ“ä½œï¼Œå¾®ä¿¡æœåŠ¡å™¨ä¼šè¿›è¡ŒéªŒè¯ï¼Œå¦‚æœéªŒè¯æˆåŠŸï¼Œå°±ä¼šå‘èµ·æ”¯ä»˜ã€‚

ç„¶åä¼šå°†æ”¯ä»˜ç»“æœè¿”å›ç»™å…¬å¸åç«¯ï¼Œä¹Ÿä¼šè¿”å›ç»™ `wx.requestPayment()` 

å¹¶ä¸”ä¼šå¾®ä¿¡é€šçŸ¥ç”¨æˆ·æ”¯ä»˜ç»“æœ



**è½åœ°ä»£ç ï¼š**



`â¡ï¸ /pages/order/detail/index.js`

```js
// è·å–é¢„ä»˜å•ä¿¡æ¯ã€æ”¯ä»˜å‚æ•°
async advancePay() {
 try {
    const payParams = await reqPrePayInfo(this.orderNo)

    if (payParams.code === 200) {
      // è¿›è¡Œå¾®ä¿¡æ”¯ä»˜
      const payInfo = await wx.requestPayment(payParams.data)
      
      console.log(payInfo)
    }
  } 
  catch {
    wx.toast({ title: 'æ”¯ä»˜é‡åˆ°é—®é¢˜ï¼Œè¯·è”ç³»å®¢æœ', icon: 'error' })
  }
}

```







### 13. å°ç¨‹åºæ”¯ä»˜-æ”¯ä»˜çŠ¶æ€æŸ¥è¯¢



**æ€è·¯åˆ†æï¼š**



é€šè¿‡è°ƒç”¨åç«¯æ¥å£è·å–æ”¯ä»˜çŠ¶æ€ï¼Œå¦‚æœæ”¯ä»˜æˆåŠŸï¼Œéœ€è¦ç»™ç”¨æˆ·æç¤ºï¼ŒåŒæ—¶è·³è½¬åˆ°è®¢å•åˆ—è¡¨é¡µé¢ã€‚



å…¬å¸åç«¯å¼€å§‹å‘å¾®ä¿¡æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼ŒæŸ¥è¯¢æ”¯ä»˜ç»“æœ

å…¬å¸æœåŠ¡å™¨ä¼šå°†å¾®ä¿¡æœåŠ¡å™¨è¿”å›çš„æ”¯ä»˜ç»“æœï¼Œè¿”å›åˆ°å®¢æˆ·ç«¯

å®¢æˆ·ç«¯æ ¹æ®æŸ¥è¯¢ç»“æœè·³è½¬åˆ°è®¢å•åˆ—è¡¨é¡µé¢



**è½åœ°ä»£ç ï¼š**

`â¡ï¸ /pages/order/detail/index.js`

```js
// è·å–é¢„ä»˜å•ä¿¡æ¯ã€æ”¯ä»˜å‚æ•°
async advancePay() {
  try {
    const payParams = await reqPrePayInfo(this.orderNo)

    if (payParams.code === 200) {
      // payParams.data å°±æ˜¯è·å–çš„æ”¯ä»˜å‚æ•°

      // è°ƒç”¨  wx.requestPayment å‘èµ·å¾®ä¿¡æ”¯ä»˜
      const payInfo = await wx.requestPayment(payParams.data)
      
      // è·å–æ”¯ä»˜ç»“æœ
      if (payInfo.errMsg === 'requestPayment:ok') {
        // æŸ¥è¯¢è®¢å•çš„æ”¯ä»˜çŠ¶æ€
        const payStatus = await reqPayStatus(this.orderNo)

        if (payStatus.code === 200) {
          wx.redirectTo({
            url: '/pages/order/list/index',
            success: () => {
              wx.toast({
                title: 'æ”¯ä»˜æˆåŠŸ',
                icon: 'success
              })
            }
          })
        }
      }
      
    }
  } catch (error) {
    wx.toast({
      title: 'æ”¯ä»˜å¤±è´¥ï¼Œè¯·è”ç³»å®¢æœ',
      icon: 'error'
    })
  }
},
```







